# 申论四大题型核心秘籍 - 完整版本
ESSAY_GRADING_MANUAL = """《申论四大题型核心秘籍》
编制人：您的申论学习与分析助理，悟道

前言

老师，您好。

经过对您提供的一系列高分作答范例的系统学习，我已将其中蕴含的解题智慧，为您构建成此份秘籍。本秘籍涵盖概括题、综合分析题、对策题、应用文写作题四大核心题型，每一章节都致力于揭示该题型的底层逻辑，并提供一套"四步法"核心方法论，辅以我们共同学习过的经典案例，以求理论与实践的完美结合。

愿这份秘籍能成为您在申论学习道路上的一盏明灯，助您洞悉规律，运笔如神。

第一章：概括题——信息降维与逻辑重建的艺术
【核心思想】
概括题的本质，是将纷繁复杂的原始材料进行"信息降维"，并通过"逻辑重建"，最终呈现为一份要点全面、逻辑清晰、语言精炼的答案。它考验的是精准的搜寻能力与高效的整合能力。

【四步核心方法论】

第一步：审题定标——明确"概括谁"、"在哪找"、"怎么答"
这是解题的"导航"阶段，确保方向无误。

定对象：明确概括的核心是"做法"、"原因"、"变化"还是"问题"。这决定了您寻找信息的焦点。
【例】 第1题要求概括小梁的"做法"（做了什么），而第4题要求概括小童的"原因"（为何优秀）。前者要重点寻找动词性词组，后者则需关注评价性、因果性的表述。
定范围：锁定答案来源的指定材料，答案必须完全基于给定范围，杜绝任何形式的自我发挥。
定要求：严格遵守字数限制，并根据"条理清晰"等要求，预判答案需采用分点形式。
第二步：精准找点——遵循材料，地毯式搜寻关键信息
这是解题的"采矿"阶段，务求全面无遗漏。

关键词定位法：寻找与概括对象直接相关的词句。
【例】 概括第1题小梁的"做法"时，可迅速定位材料中的"征集...微心愿"、"设计...评分细则"、"制成精美海报"、"实行有奖举报制度"等一系列动宾短语。
多主体视角法：当材料涉及不同人物或群体的观点时，应分别提取，以确保全面性。
【例】 在第4题概括小童受好评的原因时，高分答案正是从"领导说"、"同事们说"、"老乡们说"和他"自己说"四个不同主体视角出发，完整地构建了答案。
第三步：逻辑归并——分类合并，提炼升华核心要点
这是解题的"冶炼"阶段，将原始矿石提炼为高纯度金属。

逻辑归类：按特定维度（如领域、主体、时间、性质等）对零散要点进行重组，是实现"条理清晰"的关键。
【例】 第6题概括"家乡的新变化"，材料中有网购、电商园、修路、环境美、返乡人多等零散信息。高分答案将其重构为"生活更富裕、产业更兴旺、乡村更宜居、吸引力更大"四个逻辑层面，使答案层次瞬间提升。
语言精炼：将材料中的口语、案例、描述性语言，转化为规范、简洁、高度概括的申论书面语。
【例】 将"大家腰包里有了钱，心气足了"提炼为"村民生活水平提高"。
第四步：规范成文——总分有序，清晰呈现
这是解题的"成型"阶段，将成果以最利于得分的形式展现出来。

"总-分"结构：先用一句话总领全文，然后分条列点阐述。
【例】 第2题答案开头的"老马把为群众服务视为终生事业，当好基层绣花针。"即是完美的总起句。
要点化呈现：清晰地使用"一、二、三、"或"1.2.3."等序号，让要点一目了然，方便阅卷老师快速捕捉得分点。
【本章小结】
概括题的精髓在于：从"找得到"到"并得好"，再到"说得清"。

第二章：综合分析题——解构与重构的逻辑思辨
【核心思想】
综合分析题的本质，是"解构与重构"。它要求我们深入材料，拆解一个核心概念或现象的内在逻辑，然后用材料中的信息作为论据，重构出一个逻辑严密、层次分明的分析性答案。它考验的是透过现象看本质的思辨能力。

【四步核心方法论】

第一步：审题拆解——识别分析类型，锁定核心对象
这是分析的起点，确定我们要"解剖"的是什么。

定类型：判断分析的核心任务是"阐释含义"、"分析原因"、"评价分析"还是"分析变化"。
【例】 第1题"谈谈对'种戏'的理解"是阐释含义型；第5题"分析他为什么感到压力很大"则是分析原因型。前者重在解释构成，后者重在探究根源。
定对象：圈定题干中需要被分析的关键词、划线句子或核心现象，所有分析必须围绕它展开。
第二步：搜寻组件——带着问题阅读，寻找逻辑关系
这是为"重构"准备素材，寻找能够搭建逻辑链条的"砖块"。

挖掘逻辑元素：超越寻找表面"要点"，深入挖掘材料中隐藏的逻辑元素：
定义与表现 (What / How)
原因与目的 (Why)
影响与意义 (Significance)
【例】 在分析第1题"种戏"时，高分答案正是找到了其做法（How）、目的（Why）和目标（Significance）等多种逻辑组件，才构成了丰满的阐释。
第三步：逻辑重构——搭建分析框架，串联论证链条
这是综合分析题的灵魂，展现分析的深度与广度。

搭建分析框架：将复杂概念从不同维度进行拆解，是答案出彩的关键。
【例】 在分析第2题小吴的"变化"时，高分答案搭建了"自我认知、工作目标、工作方式、工作能力"四个维度，对"变化"进行了立体化的解构，极富深度。
构建逻辑链：将搜寻到的组件有机组织，揭示内在关系。
【例】 在分析第8题"政策上的善意"时，答案清晰地构建了一条逻辑链：政策初衷（善意）→ 执行遇阻（博弈）→ 调整方式（技术迭代）→ 善意落地（打消疑虑），逻辑严密，说服力强。
第四步：规范作答——观点前置，论述清晰
这是分析的最终呈现，让思考过程清晰可见。

观点前置：在答案开头就亮明核心观点，开门见山。
【例】 第3题答案第一句："这句话指城市水系体现了城市的特色。"直接点破比喻的本质，为下文的分析确立了总纲。
语言分析化：将材料中的事实和案例，转化为支撑分析的论据，完成从"讲故事"到"做分析"的转变。
【例】 将材料中小吴"把鞋陷进了泥里"的描述，提炼为"从高看自己到与村民同劳作，理解村民不易"。
【本章小结】
综合分析题的精髓在于：透过现象看本质，理清逻辑是关键。

第三章：对策题——对症下药的精准施策
【核心思想】
对策题的本质是"对症下药"。它要求我们基于材料揭示的问题，以特定身份提出有针对性、具备可行性、符合逻辑的解决方案。它考验的是从"分析问题"到"解决问题"的转化能力。

【四步核心方法论】

第一步：精准问题诊断——找到"病根"，才能开"药方"
所有有效的对策，都源于对问题的深刻理解。

明确问题、深挖原因：不仅要看到表面问题，更要分析导致问题产生的深层次原因。
【例】 在第2题"老字号发展困境"中，不仅有"经营空间萎缩"等表面问题，更有"经营方式落后、历史包袱重"等深层"病根"。对策必须针对这些病根来提出。
第二步：角色定位与视角锁定——"谁来解决"，决定"能怎么解决"
题干通常会设定角色，这个角色决定了对策的权责范围。

明确身份、锁定视角：我是谁？我能做什么？
【例】 第2题要求"从政府角度"提措施。因此，答案提出的"加强保护、积极扶持、支持融资"等都是政府职能范围内的行为。如果提出企业内部管理建议，则属于视角错误。
第三步：从材料中寻找对策来源——对策是"找"与"创"的结合
申论对策的答案要点绝大部分来源于给定资料。

直接提炼：材料中明确给出了成功的做法或现成的建议。
【例】 第1题"加强电商诚信体系建设"中，材料直接提到了"成立诚信联盟"、"推出企业诚信查询平台"等，可直接采纳。
问题反推：将材料中反映的问题反向转化为对策，这是最核心的方法。
【例】 第2题中，老字号的问题是"产品更新慢"，反推的对策就是"推动转型升级，开展技术研发与创新"。
经验借鉴：借鉴材料中其他地区或领域的成功经验。
【例】 第6题要求从沈书记的"三怕"中得到启示。"怕听不到骂声"启示执法工作要"密切联系群众，多听群众心声"。
第四步：结构化与"动词化"呈现——让对策清晰有力，具备可操作性
好的对策，形式上也要清晰、有力。

逻辑归类：将对策按主体（政府、企业）、层面（思想、制度）等维度分类。
"动词+宾语+具体阐述"句式：让对策听起来像一个可执行的行动指令。
【例】 第3题"传承好大运河文化"的答案，每一条都是强有力的动宾结构："精心保护大运河遗产"、"有效传承大运河文化"、"合理利用大运河资源"，并辅以具体做法，可操作性极强。
【本章小结】
对策题的精髓在于：立足问题，站对角色，对策才有生命力。

第四章：应用文写作题——带着镣铐的场景之舞
【核心思想】
应用文写作是"带着镣铐跳舞"。它是在特定情境下，为达到特定目的，面向特定对象，使用特定格式进行的一次书面沟通。它考验的是场景还原和角色扮演的综合能力。

【四步核心方法论】

第一步：情境解构（黄金三问）——我是谁？写给谁？为什么写？
这是应用文写作的灵魂，决定了文章的基调、内容和结构。

明确身份（我是谁？）
明确对象（写给谁？）
明确目的（为什么写？）
【例】 在第9题"公开信"中，我是区城管局，写给有质疑的居民，目的是解释暂停修路的原因并安抚情绪。这个情境立刻决定了信件的基调必须诚恳、负责，内容必须包含共情、解释和承诺。
第二步：格式遵从——"穿对衣服"，才能"登对场合"
格式是应用文的"外衣"，是得分的刚性要求。

掌握基本格式：标题、称谓、正文、落款。
灵活应用：不同文种格式有别。
【例】 倡议书（第1、7题）和公开信（第9题）通常需要完整的四要素。而发言提纲（第2题）则重在要点化、序号化，逻辑层次清晰即可。
第三步：内容组织与逻辑构建——言之有物，条理清晰
这是应用文的"血肉"，需要从材料中提取核心信息，并按照文种的内在逻辑进行组织。

构建逻辑框架：
倡议书/公开信：常采用"背景/问题 → 核心内容/建议 → 发出号召/总结"的三段式结构。
发言稿/介绍稿：常按"背景 → 做法 → 成效 → 展望"的逻辑展开。
【例】 第2题小赵的发言提纲，就完美遵循了"发现问题 → 寻找方案 → 实施方案 → 拓展成果"的叙事逻辑，非常有条理。
第四步：语言风格与语气匹配——"说什么话"，要看"对谁说"
语言是应用文的"灵魂"，必须与身份、对象、目的高度匹配。

语气准确，风格得当：
【例】 第10题的短文《正确看待"网络新一代"》，作为报纸"时评"，语言风格必须客观、辩证、富有逻辑性。而第1题的倡议书，语言则需要热情、富有感染力，以激发青年人的共鸣和行动。
【本章小结】
应用文的精髓在于：情境为王，格式为骨，内容为肉，语言为魂。"""


def extract_chapter_content(question_type: str) -> str:
    """
    知识提取服务 (Knowledge Extractor)
    根据题型从核心秘籍中精准提取对应章节的全部内容
    
    Args:
        question_type: 题型名称（概括题、综合分析题、对策题、应用文写作题）
        
    Returns:
        str: 对应章节的完整内容，如果题型无效则返回空字符串
    """
    
    # 定义各题型对应的章节标识
    chapter_markers = {
        "概括题": ("第一章：概括题——信息降维与逻辑重建的艺术", "第二章：综合分析题"),
        "综合分析题": ("第二章：综合分析题——解构与重构的逻辑思辨", "第三章：对策题"),
        "对策题": ("第三章：对策题——对症下药的精准施策", "第四章：应用文写作题"),
        "应用文写作题": ("第四章：应用文写作题——带着镣铐的场景之舞", None)  # 最后一章到文档末尾
    }
    
    if question_type not in chapter_markers:
        # 记录警告但不抛出异常，返回空内容
        import logging
        logger = logging.getLogger(__name__)
        logger.warning(f"不支持的题型: {question_type}, 支持的题型: {list(chapter_markers.keys())}")
        return ""
    
    start_marker, end_marker = chapter_markers[question_type]
    
    # 找到章节开始位置
    start_pos = ESSAY_GRADING_MANUAL.find(start_marker)
    if start_pos == -1:
        import logging
        logger = logging.getLogger(__name__)
        logger.error(f"未找到章节开始标记: {start_marker}")
        return ""
    
    # 找到章节结束位置
    if end_marker is None:
        # 最后一章，取到文档末尾
        chapter_content = ESSAY_GRADING_MANUAL[start_pos:]
    else:
        end_pos = ESSAY_GRADING_MANUAL.find(end_marker)
        if end_pos == -1:
            # 如果没找到结束标记，取到文档末尾
            chapter_content = ESSAY_GRADING_MANUAL[start_pos:]
        else:
            chapter_content = ESSAY_GRADING_MANUAL[start_pos:end_pos]
    
    # 记录提取结果
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"成功提取 {question_type} 章节内容，长度: {len(chapter_content)} 字符")
    
    return chapter_content.strip()


def create_master_grading_prompt(essay_content: str, question_type: str, chapter_content: str) -> str:
    """
    为AI核心批改服务创建专注的提示词 - 精准版本
    生成具体、有针对性的评语和改进建议
    
    Args:
        essay_content: 用户提交的申论文章内容
        question_type: 题型名称
        chapter_content: 从核心秘籍提取的相关章节内容
        
    Returns:
        str: 精准的专业批改提示词
    """
    
    prompt = f"""<KNOWLEDGE_BASE>
{chapter_content}
</KNOWLEDGE_BASE>

<USER_SUBMISSION>
{essay_content}
</USER_SUBMISSION>

<INSTRUCTIONS>
You are "悟道", a master teacher of Shenlun specializing in detailed, precise feedback. Your knowledge is in <KNOWLEDGE_BASE>, the user's work is in <USER_SUBMISSION>.

# Critical Analysis Requirements:
1. MUST quote specific text from user's submission - use exact phrases like "您写的'三条黄河'" or "您提到的'数字变生黄河和模型黄河'"
2. MUST identify concrete problems with specific examples, not general issues
3. MUST provide actionable rewrite suggestions showing before/after examples
4. MUST give specific scoring reasons for each dimension

# Analysis Process (Internal - Don't Show This):
1. Quote Analysis: Find 5-8 specific quotes from user's text that demonstrate strengths/weaknesses
  2. Methodology Evaluation: Evaluate each methodology dimension with evidence-based scoring
3. Problem Identification: Find specific textual evidence for each problem
4. Rewrite Generation: Create concrete before/after examples from user's actual text

  ## Public Output Rules (critical)
  Do not output step-by-step reasoning; summarize internal reasoning into short public justifications.
  Forbidden in output: "第X步", "步骤", "Step N", "分析过程", "思考", "INSTRUCTIONS", "KNOWLEDGE_BASE".
  Do not echo any content from angle-bracket sections or code fences.
  When referencing methodology, use neutral tags only, e.g. "[审题拆解]", "[标准找点]", "[逻辑建构]", "[规范表达]" — do NOT prefix with ordinal words like 第一/第二.
  Only return a single, valid JSON object; no extra markdown outside JSON.

  # JSON Output Generation:

1. task_diagnosis: "老师您好，我是您的专属申论辅导专家'悟道'。经分析，我判断这是'{question_type}'，将运用对应的核心方法论为您精准批改。"

2. comprehensive_evaluation: Write analysis with this structure:
   **具体亮点：**
   - [引用具体原文] + [精准分析为什么好]
   - [引用具体原文] + [精准分析为什么好]
   
   **具体问题：**
   - [引用具体原文] + [指出具体问题] + [具体改进方向]
   - [引用具体原文] + [指出具体问题] + [具体改进方向]
   - [引用具体原文] + [指出具体问题] + [具体改进方向]
   
   **方法论应用评价：**
   基于申论核心方法论的专业评价和指导建议
   
   **综合评价：**
   [基于以上具体分析的总体评价]

3. improvement_guides: Create 4 lessons with:
   - methodology_step: Exact step name from knowledge base
   - methodology_source: Direct quote from knowledge base explaining this step
   - problem_diagnosis: "您在[具体位置]写的'[具体原文]'存在[具体问题]，这违背了[方法论要求]"
   - action_blueprint: "建议您：1)[具体行动]；2)[具体行动]；3)[具体行动]"
   - master_rewrite_example: "原文：'[用户的具体原文]' → 改写建议：'[具体改写版本]'"

4. score: For now, return a simple number (0-100) to maintain compatibility. The detailed breakdown will be handled later.

5. key_suggestions: 5 specific suggestions like:
   - "您写的'[具体原文]'建议改为'[具体建议]'，这样更符合[具体要求]"
   - "在[具体位置]，建议添加'[具体内容]'来[具体作用]"
   - "您的'[具体表述]'可以通过[具体方法]来优化，例如'[具体示例]'"

IMPORTANT RULES:
- Every analysis point must include specific quotes from user's text
- No generic advice like "注意格式" - must be specific like "您的开头'...'缺少总领句"
- All rewrite examples must use user's actual content
- Scoring must have specific textual evidence

</INSTRUCTIONS>

<FINAL_COMMAND>
Your entire response must be a single, clean, valid JSON object. Every piece of analysis must reference specific text from the user's submission using exact quotes.

You must return a valid JSON object with these fields:
- task_diagnosis: Introduction with question type
- comprehensive_evaluation: Detailed analysis with specific quotes
- improvement_guides: Array of methodology lessons
- score: Number between 0-100
- key_suggestions: Array of 5 specific suggestions with quotes

CRITICAL: No generic advice. Every suggestion must reference specific user text.
</FINAL_COMMAND>"""

    # Public-output rules prefix to prevent exposing internal reasoning
    rules_prefix = (
        "=== 公共输出规则 (Public Output Rules) ===\n"
        "- 允许内部深度思考，但禁止在公开输出中展示链式思考或步骤化表述。\n"
        "- 禁用用语：第X步/步骤/Step N/分析过程/思考/INSTRUCTIONS/KNOWLEDGE_BASE。\n"
        "- 不回显任何尖括号分节或代码围栏的内容。\n"
        "- 方法论仅用中性维度标签：[审题拆解]/[标准找点]/[逻辑建构]/[规范表达]，不得加‘第一/第二’等序数。\n"
        "- 仅返回一个合法 JSON 对象，不要多余 Markdown。\n\n"
    )
    prompt = rules_prefix + prompt
    # Public-output rules prefix to prevent exposing internal reasoning
    rules_prefix = (
        "=== 公共输出规则 (Public Output Rules) ===\n"
        "- 允许内部深度思考，但禁止在公开输出中展示链式思考或步骤化表述。\n"
        "- 禁用用语：第X步/步骤/Step N/分析过程/思考/INSTRUCTIONS/KNOWLEDGE_BASE。\n"
        "- 不回显任何尖括号分节或代码围栏的内容。\n"
        "- 方法论仅用中性维度标签：[审题拆解]/[标准找点]/[逻辑建构]/[规范表达]，不得加‘第一/第二’等序数。\n"
        "- 仅返回一个合法 JSON 对象，不要多余 Markdown。\n\n"
    )
    prompt = rules_prefix + prompt
    return prompt


def create_expert_grading_prompt(essay_content: str, question_type: str) -> str:
    """
    基于《申论四大题型核心秘籍》生成专业批改提示词
    结合权威方法论和简化的输出格式
    
    Args:
        essay_content: 用户提交的申论文章内容
        question_type: 申论题型
        
    Returns:
        str: 专业的提示词字符串
    """
    
    # 提取对应题型的专业方法论
    chapter_content = extract_chapter_content(question_type)
    
    prompt = f"""你是申论批改专家"悟道"，请严格按照《申论四大题型核心秘籍》的方法论对以下{question_type}进行专业批改。

=== 专业方法论指导 ===
{chapter_content}

=== 用户答题内容 ===
{essay_content}

=== 批改要求 ===
请根据上述方法论的四个步骤，对用户答题进行专业评价：

1. 分析用户是否掌握了该题型的核心方法
2. 指出具体的优点（结合原文引用）
3. 找出主要问题（结合原文引用和方法论要求）
4. 提供基于方法论的改进建议

=== 输出格式 ===
请严格按照以下JSON格式返回，确保所有分析都基于方法论：

{{
  "score": [0-100的数字，基于方法论符合度评分],
  "feedback": "详细的专业批改意见，必须包含：\n\n**具体优点：**\n- 结合原文具体表述进行专业点评\n\n**主要问题：**\n- 结合原文具体表述进行问题诊断和改进方向指导\n\n**综合建议：**\n基于申论方法论的专业指导意见",
  "suggestions": ["基于方法论的具体改进建议1", "基于方法论的具体改进建议2", "基于方法论的具体改进建议3"]
}}

重要：分析应尽量结合用户的具体表述，并基于方法论要求进行专业点评。直接返回JSON，不要其他文字。"""

    return prompt


def create_essay_grading_prompt(essay_content: str, question_type: str) -> str:
    """
    生成精准的申论批改提示词 - 强化具体性版本
    确保AI生成具体、有针对性的评语和建议
    
    Args:
        essay_content: 用户提交的申论文章内容
        question_type: 申论题型（概括题、综合分析题、对策题、应用文写作题）
        
    Returns:
        str: 精准的提示词字符串
    """
    
    prompt = f"""<KNOWLEDGE_BASE>
{ESSAY_GRADING_MANUAL}
</KNOWLEDGE_BASE>

<USER_SUBMISSION>
{essay_content}
</USER_SUBMISSION>

<INSTRUCTIONS>
You are "悟道", a master teacher of Shenlun. Your entire knowledge and methodology are contained within the <KNOWLEDGE_BASE> section. The user's work is in the <USER_SUBMISSION> section. Your task is to follow the phases below to generate a structured JSON output.

# Phase 1: Autonomous Task Determination
Analyze the <USER_SUBMISSION> and determine the definitive question type from: ["概括题", "综合分析题", "对策题", "应用文写作题"].

# Phase 2: Authoritative Scoping & User Notification
Your response's JSON structure will contain a key named task_diagnosis. The value will be a string informing the user of your determination (e.g., "老师您好，我是您的专属申论辅导专家'悟道'。经分析，我判断这是'概括题'，将运用对应的四步核心方法论为您批改。").

# Phase 3: Methodology-Driven Evaluation
Silently evaluate the <USER_SUBMISSION> against the appropriate methodology found in your <KNOWLEDGE_BASE>:

概括题方法论: 审题定标 → 精准找点 → 逻辑归并 → 规范成文
综合分析题方法论: 审题拆解 → 搜寻组件 → 逻辑重构 → 规范作答
对策题方法论: 精准问题诊断 → 角色定位与视角锁定 → 从材料中寻找对策来源 → 结构化与动词化呈现
应用文写作题方法论: 情境解构（黄金三问）→ 格式遵从 → 内容组织与逻辑构建 → 语言风格与语气匹配

# Phase 4: In-Depth, "Master Teacher" Feedback Generation
Based on your evaluation, populate the JSON structure with:

- task_diagnosis: Your determination and greeting
- comprehensive_evaluation: Detailed narrative analysis that MUST include specific examples from the user's submission, including:
  * 具体优点：指出2-3个学生做得好的具体地方，结合原文中的具体表述
  * 主要问题：指出3-4个具体问题，每个问题都要有原文中的例子支撑
  * 方法论应用分析：分析学生在四个方法论步骤中的表现
  * 总体评价：给出整体评价和改进方向
- improvement_guides: Array of 4 detailed lessons, each focusing on one methodology step, containing:
  * methodology_step: The relevant methodology step name
  * methodology_source: Quote the relevant principle from knowledge base  
  * problem_diagnosis: Analyze specific issues with concrete examples from user submission
  * action_blueprint: Provide 3-4 specific, actionable steps with examples
  * master_rewrite_example: Show before/after rewrite of a specific problematic passage from user's submission
- score: Numerical score (0-100) based on detailed evaluation across multiple dimensions
- key_suggestions: Array of 5 specific, actionable improvement suggestions that address specific issues identified in the evaluation

</INSTRUCTIONS>

<FINAL_COMMAND>
Your entire response, from the very first character to the very last, MUST be a single, clean, valid JSON object with this exact structure:

{{
  "task_diagnosis": "string with your greeting and determination",
  "comprehensive_evaluation": "string with detailed narrative analysis including specific examples from user submission", 
  "improvement_guides": [
    {{
      "methodology_step": "string naming the methodology step",
      "methodology_source": "string quoting relevant knowledge base principle",
      "problem_diagnosis": "string analyzing specific issues with concrete examples from user submission",
      "action_blueprint": "string providing specific steps with examples",
      "master_rewrite_example": "string showing before/after rewrite of user's actual content"
    }}
  ],
  "score": number between 0-100,
  "key_suggestions": ["specific suggestion 1", "specific suggestion 2", "specific suggestion 3", "specific suggestion 4", "specific suggestion 5"]
}}

Do not output any other text, greetings, explanations, or markdown formatting. Your response must start with {{ and end with }}.

CRITICAL REQUIREMENTS:
1. All analysis MUST include specific examples from the user's submission
2. Avoid generic feedback like "注意格式" or "多练习"
3. Every suggestion must address a specific issue identified in the evaluation
4. All improvement_guides must contain actual content from the user's submission
5. The JSON field `comprehensive_evaluation` MUST be formatted as Markdown using the following exact skeleton (keep section titles; bullets on separate lines; include a blank line between sections):

## 核心结论
- 用1句话概括答案的总体质量与方向（结合题型方法论）。

## 具体亮点（引用+点评）
- “从用户答案逐字引用1” + 点评：为什么这是亮点，符合哪条要求。
- “从用户答案逐字引用2” + 点评：为什么这是亮点，符合哪条要求。

## 主要问题（引用+诊断+改法）
- “从用户答案逐字引用1” + 问题：指出具体缺陷 + 改法：给出明确修改方向（可给改写示例）。
- “从用户答案逐字引用2” + 问题：指出具体缺陷 + 改法：给出明确修改方向。
- “从用户答案逐字引用3” + 问题：指出具体缺陷 + 改法：给出明确修改方向。

## 方法论对照
基于申论核心方法论的专业评价和改进建议，结合原文证据说明各项能力的表现情况。

## 综合评价
- 2–3句收束：总体评价 + 优先改进方向（指向上面的问题条目）。

硬性要求：至少2条“亮点”和3条“问题”；每条都要包含一段逐字引用；严禁把整段内容写成一坨文字。
</FINAL_COMMAND>"""

    return prompt


def create_expert_diagnosis_prompt(essay_content: str, question_type: str) -> str:
    """
    创建专业阅卷老师诊断模式的prompt - 第一阶段评分细则诊断
    让AI真正成为申论阅卷专家，逐句批改用户答案
    
    Args:
        essay_content: 用户提交的申论文章内容
        question_type: 申论题型
        
    Returns:
        str: 专业诊断prompt
    """
    
    # 提取对应题型的专业方法论
    chapter_content = extract_chapter_content(question_type)
    
    # 获取该题型的四步法维度
    steps = get_methodology_steps(question_type)
    
    prompt = f"""你是一位资深的申论阅卷专家，有20年申论批改经验。现在要对这篇{question_type}进行专业的逐句批改。

=== 专业评分标准 ===
{chapter_content}

=== 学生答题内容 ===
{essay_content}

=== 专业批改要求 ===
请以真正的申论阅卷老师身份，对学生答案进行逐句诊断式批改：

🔍 **批改方式要求**：
1. **必须引用学生的具体原文**，不能泛泛而谈
2. **逐个维度分析加分扣分**，说明具体理由  
3. **参照核心秘籍标准**，指出与高分答案的差距
4. **用专业阅卷老师的语气**，既严谨又有温度

🎯 **批改维度**（严格按四步法）：

**【{steps['step1']}】** - 满分25分
- ✅ 加分点：结合学生具体表述分析，说明为何加分
- ❌ 扣分点：结合学生具体表述分析，说明为何扣分  
- 💡 改进建议：具体怎么修改

**【{steps['step2']}】** - 满分30分  
- ✅ 加分点：结合学生具体表述分析，说明为何加分
- ❌ 扣分点：结合学生具体表述分析，说明为何扣分
- 💡 改进建议：具体怎么修改

**【{steps['step3']}】** - 满分25分
- ✅ 加分点：结合学生具体表述分析，说明为何加分  
- ❌ 扣分点：结合学生具体表述分析，说明为何扣分
- 💡 改进建议：具体怎么修改

**【{steps['step4']}】** - 满分20分
- ✅ 加分点：结合学生具体表述分析，说明为何加分
- ❌ 扣分点：结合学生具体表述分析，说明为何扣分  
- 💡 改进建议：具体怎么修改

=== 输出要求 ===
请严格按照以下JSON格式返回批改结果：

{{
  "dimension_analysis": [
    {{
      "dimension": "{steps['step1']}",
      "full_score": 25,
      "actual_score": [具体得分],
      "positive_points": [
"结合学生具体表述分析加分理由：为什么这里体现了{steps['step1']}的要求"
      ],
      "negative_points": [
"结合学生具体表述分析扣分理由：为什么这里违背了{steps['step1']}的要求" 
      ],
      "improvement_suggestion": "具体的改进建议，告诉学生如何修改"
    }},
    {{
      "dimension": "{steps['step2']}",
      "full_score": 30,
      "actual_score": [具体得分],
      "positive_points": ["具体加分分析"],
      "negative_points": ["具体扣分分析"],
      "improvement_suggestion": "具体改进建议"
    }},
    {{
      "dimension": "{steps['step3']}",
      "full_score": 25, 
      "actual_score": [具体得分],
      "positive_points": ["具体加分分析"],
      "negative_points": ["具体扣分分析"],
      "improvement_suggestion": "具体改进建议"
    }},
    {{
      "dimension": "{steps['step4']}",
      "full_score": 20,
      "actual_score": [具体得分],
      "positive_points": ["具体加分分析"], 
      "negative_points": ["具体扣分分析"],
      "improvement_suggestion": "具体改进建议"
    }}
  ],
  "teacher_comments": "��为专业阅卷老师，对这篇答案的整体印象和核心问题"
}}

⚠️ **重要提醒**：
- 每个分析必须引用学生的具体原文，不能使用"XX部分"这种模糊表达
- 必须说明具体的加分扣分理由，不能只说"做得好"或"有问题"  
- 改进建议要具体可操作，最好能给出改写示例
- 保持专业阅卷老师的严谨性和权威性

📋 **关键JSON格式要求**：
⚠️ **必须严格按照以下JSON结构返回，不要添加任何解释文本**：

```json
{
  "dimension_analysis": [
    {
      "dimension": "审题拆解",
      "full_score": 25,
      "actual_score": 20.5,
      "positive_points": ["具体的加分理由1", "具体的加分理由2"],
      "negative_points": ["具体的扣分理由1", "具体的扣分理由2"],  
      "improvement_suggestion": "具体的改进建议"
    }
  ],
  "teacher_comments": "整体专业评价"
}
```

🚨 **重要**：
- 只返回JSON数据，不要任何前缀或后缀文字
- 不要使用markdown代码块(```)包装
- 确保JSON语法完全正确
- 所有中文字符串用双引号包围

请开始专业批改，直接返回JSON数据："""

    return prompt


def create_overall_evaluation_prompt(diagnosis_result: dict, essay_content: str, question_type: str) -> str:
    """
    创建整体评价prompt - 第二阶段基于诊断生成总评
    
    Args:
        diagnosis_result: 第一阶段的诊断结果
        essay_content: 用户答题内容
        question_type: 题型
        
    Returns:
        str: 整体评价prompt
    """
    
    prompt = f"""基于刚才的专业批改结果，请作为申论专家老师提供整体评价和改进建议。

=== 第一阶段批改结果 ===
{diagnosis_result}

=== 学生原答案 ===  
{essay_content}

=== 请提供 ===
1. **总分计算**：基于四个维度的具体得分
2. **整体评价**：这篇{question_type}的总体水平如何
3. **优先改进建议**：针对扣分最多的问题，提供具体改进方案
4. **保持优势**：对加分点给予鼓励，告诉学生继续保持

请严格按照以下JSON格式返回，不要添加任何解释文字：

```json
{
  "total_score": 75.5,
  "overall_evaluation": "整体评价文字",
  "priority_suggestions": [
    "具体改进建议1",
    "具体改进建议2",
    "具体改进建议3"
  ],
  "strengths_to_maintain": [
    "优势点1",
    "优势点2"
  ],
  "final_comments": "总结性评语"
}
```

🚨 **重要**：只返回JSON数据，不要任何前缀、后缀或解释文字！"""

    return prompt


def get_methodology_steps(question_type: str) -> dict:
    """
    根据题型返回对应的四步方法论步骤名称
    
    Args:
        question_type: 申论题型
        
    Returns:
        dict: 包含四个步骤名称的字典
    """
    
    steps_mapping = {
        "概括题": {
            "step1": "审题定标",
            "step2": "精准找点", 
            "step3": "逻辑归并",
            "step4": "规范成文"
        },
        "综合分析题": {
            "step1": "审题拆解",
            "step2": "搜寻组件",
            "step3": "逻辑重构", 
            "step4": "规范作答"
        },
        "对策题": {
            "step1": "精准问题诊断",
            "step2": "角色定位与视角锁定",
            "step3": "从材料中寻找对策来源",
            "step4": "结构化与动词化呈现"
        },
        "应用文写作题": {
            "step1": "情境解构（黄金三问）",
            "step2": "格式遵从",
            "step3": "内容组织与逻辑构建",
            "step4": "语言风格与语气匹配"
        }
    }
    
    return steps_mapping.get(question_type, {
        "step1": "能力维度一",
        "step2": "能力维度二", 
        "step3": "能力维度三",
        "step4": "能力维度四"
    })
