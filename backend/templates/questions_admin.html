<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö È¢òÁõÆÂ∫ìÁÆ°ÁêÜÁ≥ªÁªü</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #e8f0fe;
        }

        .upload-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1.1em;
        }

        .file-input-button:hover {
            background: #5a67d8;
        }

        .upload-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .upload-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .questions-section {
            margin-top: 30px;
        }

        .questions-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .question-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .question-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .question-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .question-meta {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .question-images {
            margin: 10px 0;
        }

        .question-images img {
            max-width: 200px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .type-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .type-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .recent-extractions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .extraction-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .extraction-item.success {
            border-color: #28a745;
        }

        .extraction-item.error {
            border-color: #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .questions-section h2 {
            position: relative;
        }
        
        .questions-controls {
            position: sticky;
            top: 0;
            background: #ffffff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .questions-controls button {
            padding: 5px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .questions-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .questions-controls select {
            padding: 5px 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .questions-controls select:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .questions-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .questions-controls input[type="text"],
        .questions-controls input[type="number"] {
            padding: 5px 10px;
            margin-right: 4px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .danger-section {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .danger-section h3 {
            color: #e53e3e;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .danger-button {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .danger-button:hover {
            background: linear-gradient(45deg, #c53030, #9c2626);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }
        
        .danger-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .questions-controls {
                float: none;
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .questions-controls select {
                margin-right: 0;
                width: 100%;
            }
            
            .questions-controls button {
                display: block;
                width: 100%;
                margin: 0;
            }
            
            .danger-section {
                padding: 15px;
            }
            
            .danger-section h3 {
                font-size: 1.1em;
            }
            
            .danger-button {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ® -->
        <div class="header">
            <h1>üìö È¢òÁõÆÂ∫ìÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>Âü∫‰∫é‰∫∫Á±ªÈÄªËæëÁöÑÊô∫ËÉΩÈ¢òÁõÆÊèêÂèñ | ÊàêÂäüÁéá90-95%</p>
        </div>

        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ total_questions }}</div>
                <div class="stat-label">È¢òÁõÆÊÄªÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_extractions }}</div>
                <div class="stat-label">ÊèêÂèñÊ¨°Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTypeCount">--</div>
                <div class="stat-label">È¢òÁõÆÁ±ªÂûã</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTotalExpected">--</div>
                <div class="stat-label">ÂΩìÂâçÊòæÁ§∫/ÊÄªÊï∞</div>
            </div>
        </div>

        <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
        <div class="main-content">
            <!-- È¢òÂûãÂàÜÂ∏É -->
            <div class="recent-extractions" id="typeDistributionBlock" style="display:none;">
                <h3>üìä È¢òÂûãÂàÜÂ∏É</h3>
                <div class="type-distribution" id="typeDistribution"></div>
            </div>

            <!-- È¢òÂûãÊ∏ÖÊ¥óÂª∫ËÆÆ/ÂéüÂßãÁ±ªÂûã -->
            <div class="recent-extractions" id="typeInsightsBlock" style="display:none;">
                <h3>üßπ È¢òÂûãÊ∏ÖÊ¥óÂª∫ËÆÆ</h3>
                <div id="typeInsights" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;"></div>
            </div>

            <!-- ÊñáÊ°£‰∏ä‰º†Âå∫Âüü -->
            <div class="upload-section">
                <h2>üìÑ ÊñáÊ°£‰∏ä‰º†‰∏éËß£Êûê</h2>
                <p>ÊîØÊåÅ‰∏ä‰º† .docx Ê†ºÂºèÁöÑÂÖ¨Âä°ÂëòËÄÉËØïÈ¢òÁõÆÊñáÊ°£</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".docx">
                    <label for="fileInput" class="file-input-button">
                        üóÇÔ∏è ÈÄâÊã©Êñá‰ª∂
                    </label>
                </div>
                
                <button id="uploadButton" class="upload-button" disabled>
                    üöÄ ÂºÄÂßãËß£Êûê
                </button>

                <div id="progress" class="progress">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>Ê≠£Âú®Ëß£ÊûêÊñáÊ°£ÔºåËØ∑Á®çÂÄô...</div>
                    </div>
                </div>

                <div id="uploadResult"></div>
            </div>

            <!-- ÊúÄËøëÊèêÂèñËÆ∞ÂΩï -->
            {% if recent_extractions %}
            <div class="recent-extractions">
                <h3>üìà ÊúÄËøëÊèêÂèñËÆ∞ÂΩï</h3>
                {% for extraction in recent_extractions %}
                <div class="extraction-item {{ 'success' if extraction.success else 'error' }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ extraction.filename }}</strong>
                            <br>
                            <small>
                                È¢òÁõÆ: {{ extraction.total_questions_extracted or 0 }}ÈÅì | 
                                ÂõæÁâá: {{ extraction.total_images_extracted or 0 }}Âº† | 
                                Áî®Êó∂: {{ extraction.processing_time_seconds or 0 }}Áßí
                            </small>
                        </div>
                        <div style="color: {{ '#28a745' if extraction.success else '#dc3545' }};">
                            {{ '‚úÖ ÊàêÂäü' if extraction.success else '‚ùå Â§±Ë¥•' }}
                        </div>
                    </div>
                    {% if not extraction.success and extraction.error_message %}
                    <div style="color: #dc3545; font-size: 0.9em; margin-top: 5px;">
                        ÈîôËØØ: {{ extraction.error_message }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ÁÆ°ÁêÜÊìç‰ΩúÂå∫Âüü -->
            <div class="danger-section">
                <h3>‚ö†Ô∏è Âç±Èô©Êìç‰ΩúÂå∫Âüü</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    ‰ª•‰∏ãÊìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåËØ∑Ë∞®ÊÖé‰ΩøÁî®ÔºÅÊ∏ÖÁ©∫ÂêéÊâÄÊúâÈ¢òÁõÆ„ÄÅÂõæÁâáÂíåÁõ∏ÂÖ≥Êï∞ÊçÆÂ∞ÜË¢´Ê∞∏‰πÖÂà†Èô§„ÄÇ
                </p>
                <div>
                    <button id="clearAllButton" onclick="showClearDialog()" class="danger-button" title="Ê∏ÖÁ©∫ÊâÄÊúâÈ¢òÁõÆÂíåÂõæÁâáÊï∞ÊçÆ">
                        üóëÔ∏è Ê∏ÖÁ©∫È¢òÂ∫ì
                    </button>
                    <span style="color: #666; font-size: 12px; margin-left: 10px;">
                        Âª∫ËÆÆÂú®ÈáçÊñ∞ÂØºÂÖ•È¢òÁõÆÂâç‰ΩøÁî®Ê≠§ÂäüËÉΩ
                    </span>
                </div>
            </div>

            <!-- È¢òÁõÆÂàóË°® -->
            <div class="questions-section">
                <h2>üìã È¢òÁõÆÂàóË°®</h2>
                <div class="questions-controls">
                    <select id="typeFilter" onchange="onTypeFilterChange()" title="ÊåâÈ¢òÂûãÁ≠õÈÄâ">
                        <option value="">üìö ÂÖ®ÈÉ®È¢òÂûã</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ÂÖ≥ÈîÆËØç..." onkeydown="if(event.key==='Enter'){onSearch()}" />
                    <input type="number" id="jumpInput" placeholder="Ë∑≥Âà∞È¢òÂè∑" min="1" style="width:100px;" onkeydown="if(event.key==='Enter'){onJump()}" />
                    <select id="sortSelect" onchange="onSortChange()" title="ÊéíÂ∫è">
                        <option value="number-asc">È¢òÂè∑ ‚Üë</option>
                        <option value="number-desc">È¢òÂè∑ ‚Üì</option>
                        <option value="created_at-desc">ÊúÄÊñ∞ÂàõÂª∫</option>
                        <option value="created_at-asc">ÊúÄÊó©ÂàõÂª∫</option>
                    </select>
                    <select id="pageSizeSelect" onchange="onPageSizeChange()" title="ÊØèÈ°µÊï∞Èáè">
                        <option value="10">ÊØèÈ°µ10</option>
                        <option value="20" selected>ÊØèÈ°µ20</option>
                        <option value="50">ÊØèÈ°µ50</option>
                    </select>
                    <button onclick="reloadList()" style="background: #6c757d;" title="Âà∑Êñ∞È¢òÁõÆÂàóË°®">üîÑ Âà∑Êñ∞</button>
                </div>
                <div id="questionsList">
                    <div class="loading" id="questionsLoading">
                        <div class="spinner"></div>
                        <div>Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆÂàóË°®...</div>
                    </div>
                    {% if ssr_questions and ssr_questions|length > 0 %}
                    <div id="ssrFallback" style="padding:10px 0;">
                        <div style="margin-bottom: 10px; color:#999; font-size:12px;">ÔºàÈ¶ñÂ±èÊúçÂä°Á´ØÊ∏≤ÊüìÔºåJSÂä†ËΩΩÂêéÂ∞ÜËá™Âä®Âà∑Êñ∞Ôºâ</div>
                        {% for q in ssr_questions %}
                        <div class="question-item">
                            <div class="question-header">
                                <span class="question-number">Á¨¨{{ q.question_number }}È¢ò</span>
                                <span class="question-type">{{ q.question_type }}</span>
                                <button onclick="viewQuestionDetail('{{ q.id }}')" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Êü•ÁúãËØ¶ÊÉÖ</button>
                            </div>
                            <div class="question-meta">
                                üìù ÂõæÁâáÊï∞Èáè: {{ q.total_images or 0 }}Âº† | üìÑ ÊÆµËêΩËåÉÂõ¥: {{ q.paragraph_range or 'Êú™Áü•' }} | üïí ÂàõÂª∫Êó∂Èó¥: {{ q.created_at or 'Êú™Áü•' }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div id="paginationBar" style="display:none; text-align:center; margin-top:10px;">
                    <button id="prevPageBtn" onclick="prevPage()" style="background:#667eea;">‰∏ä‰∏ÄÈ°µ</button>
                    <span id="pageInfo" style="margin:0 10px; color:#666;"></span>
                    <button id="nextPageBtn" onclick="nextPage()" style="background:#667eea;">‰∏ã‰∏ÄÈ°µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentFile = null;

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
            document.getElementById('fileInput').addEventListener('change', function(e) {
                currentFile = e.target.files[0];
                const uploadButton = document.getElementById('uploadButton');
                
                if (currentFile && currentFile.name.endsWith('.docx')) {
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = 'üöÄ ÂºÄÂßãËß£Êûê ' + currentFile.name;
                } else {
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = 'üöÄ ÂºÄÂßãËß£Êûê';
                    if (currentFile) {
                        showAlert('ËØ∑ÈÄâÊã© .docx Ê†ºÂºèÁöÑÊñá‰ª∂', 'error');
                    }
                }
            });

            // ‰∏ä‰º†ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('uploadButton').addEventListener('click', uploadDocument);

            // ÂàùÂßãÂåñÁªüËÆ°‰∏éÁ≠õÈÄâ
            refreshStatsAndFilters();
            // Âä†ËΩΩÈ¢òÁõÆÂàóË°®
            reloadList();
        });

        // ‰∏ä‰º†ÊñáÊ°£ÂáΩÊï∞
        async function uploadDocument() {
            if (!currentFile) {
                showAlert('ËØ∑ÂÖàÈÄâÊã©Êñá‰ª∂', 'error');
                return;
            }

            const uploadButton = document.getElementById('uploadButton');
            const progress = document.getElementById('progress');
            const loading = progress.querySelector('.loading');
            
            // ÊòæÁ§∫ËøõÂ∫¶
            uploadButton.disabled = true;
            uploadButton.innerHTML = '‚è≥ Ëß£Êûê‰∏≠...';
            progress.classList.add('show');
            if (loading) {
                loading.style.display = 'block';
            }

            const formData = new FormData();
            formData.append('file', currentFile);

            try {
                const response = await fetch('/api/v1/questions/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(
                        `üéâ Ëß£ÊûêÊàêÂäüÔºÅ\\n` +
                        `üìä ÊèêÂèñÈ¢òÁõÆ: ${result.questions_count}ÈÅì\\n` +
                        `üñºÔ∏è ÁªüËÆ°ÂõæÁâá: ${result.images_count}Âº†\\n` +
                        `üíæ ‰øùÂ≠òÂõæÁâá: ${result.images_saved || 0}Âº†\\n` +
                        `‚è±Ô∏è Â§ÑÁêÜÊó∂Èó¥: ${result.processing_time}Áßí\\n` +
                        `‚úÖ Â∑≤‰øùÂ≠ò: ${result.questions_saved}ÈÅìÈ¢òÁõÆ`,
                        'success'
                    );
                    
                    // ÊòæÁ§∫È™åËØÅÁªìÊûú
                    if (result.validation && result.validation.issues.length > 0) {
                        showAlert('ÂèëÁé∞ÁöÑÈóÆÈ¢ò:\\n' + result.validation.issues.join('\\n'), 'error');
                    }
                    
                    // Âà∑Êñ∞ÁªüËÆ°‰∏éÂàóË°®Ôºà‰∏çÊï¥È°µÂà∑Êñ∞Ôºâ
                    await refreshStatsAndFilters();
                    await reloadList();
                } else {
                    throw new Error(result.detail || result.message || 'Ëß£ÊûêÂ§±Ë¥•');
                }

            } catch (error) {
                console.error('‰∏ä‰º†ÈîôËØØ:', error);
                showAlert('Ëß£ÊûêÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'üöÄ ÂºÄÂßãËß£Êûê';
                if (loading) {
                    loading.style.display = 'none';
                }
                progress.classList.remove('show');
                
                // Ê∏ÖÈô§Êñá‰ª∂ÈÄâÊã©
                document.getElementById('fileInput').value = '';
                currentFile = null;
            }
        }

        // ÂàóË°®Êü•ËØ¢Áä∂ÊÄÅ
        let state = {
            page: 1,
            pageSize: 20,
            questionType: '',
            search: '',
            sortBy: 'number',
            order: 'asc',
            total: 0
        };

        function buildQuery() {
            const params = new URLSearchParams();
            params.set('page', String(state.page));
            params.set('page_size', String(state.pageSize));
            if (state.questionType) params.set('question_type', state.questionType);
            if (state.search) params.set('search', state.search);
            params.set('sort_by', state.sortBy);
            params.set('order', state.order);
            return params.toString();
        }

        async function reloadList() {
            await loadQuestions();
        }

        // Âä†ËΩΩÈ¢òÁõÆÂàóË°®
        async function loadQuestions() {
            const questionsList = document.getElementById('questionsList');
            const loading = document.getElementById('questionsLoading');
            
            // ‰ªéÊéß‰ª∂ËØªÂèñÂΩìÂâçÁä∂ÊÄÅ
            const typeFilter = document.getElementById('typeFilter');
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            
            state.questionType = typeFilter ? typeFilter.value : '';
            state.search = searchInput ? (searchInput.value || '') : '';
            if (sortSelect) {
                const [key, dir] = sortSelect.value.split('-');
                state.sortBy = key === 'created_at' ? 'created_at' : 'number';
                state.order = dir === 'desc' ? 'desc' : 'asc';
            }
            if (pageSizeSelect) {
                state.pageSize = parseInt(pageSizeSelect.value || '20', 10);
            }
            
            // Ê£ÄÊü•loadingÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            if (loading) {
                loading.style.display = 'block';
                let loadingText = '';
                if (state.questionType) {
                    loadingText = `Ê≠£Âú®Âä†ËΩΩ${state.questionType}È¢òÁõÆ...`;
                } else {
                    loadingText = `Ê≠£Âú®Âä†ËΩΩÁ¨¨ ${state.page} È°µ...`;
                }
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <div>${loadingText}</div>
                `;
            }

            try {
                const url = `/api/v1/questions?${buildQuery()}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.questions) {
                    state.total = data.total || 0;
                    // ÂΩìÈ°µÁ†ÅË∂ÖÂá∫ËåÉÂõ¥ÂØºËá¥Á©∫ÂàóË°®Êó∂ÔºåËá™Âä®ÂõûÈÄÄÂà∞ÊúÄÂêé‰∏ÄÈ°µÂπ∂ÈáçËΩΩÔºåÈÅøÂÖç‚ÄúÊÄªÊï∞>0‰ΩÜÊó†Êï∞ÊçÆ‚ÄùÁöÑÂÅáÁ©∫Áä∂ÊÄÅ
                    const totalPages = Math.max(1, Math.ceil((state.total) / Math.max(1, state.pageSize)));
                    if ((state.total > 0) && (!Array.isArray(data.questions) || data.questions.length === 0) && state.page > totalPages) {
                        state.page = totalPages;
                        return await loadQuestions();
                    }

                    displayQuestions(data.questions, data.total);
                    updatePaginationBar();
                    updateExpectedCard(data.questions.length, data.total);
                } else {
                    questionsList.innerHTML = '<div class="alert error">Âä†ËΩΩÈ¢òÁõÆÂàóË°®Â§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈ¢òÁõÆÂ§±Ë¥•:', error);
                questionsList.innerHTML = '<div class="alert error">Âä†ËΩΩÈ¢òÁõÆÂàóË°®Â§±Ë¥•: ' + error.message + '</div>';
            } finally {
                if (loading) {
                    loading.style.display = 'none';
                }
            }
        }

        // ÊêúÁ¥¢
        function onSearch() {
            state.page = 1;
            reloadList();
        }

        // È¢òÂûãÁ≠õÈÄâÂèòÂåñÂ§ÑÁêÜ
        function onTypeFilterChange() {
            state.page = 1;
            reloadList();
        }

        // ÊéíÂ∫è
        function onSortChange() {
            state.page = 1;
            reloadList();
        }

        // ÊØèÈ°µÊï∞Èáè
        function onPageSizeChange() {
            state.page = 1;
            reloadList();
        }

        // Ë∑≥ËΩ¨È¢òÂè∑
        function onJump() {
            const jumpInput = document.getElementById('jumpInput');
            const val = parseInt(jumpInput.value || '0', 10);
            if (val > 0) {
                state.search = '';
                state.questionType = '';
                state.sortBy = 'number';
                state.order = 'asc';
                // Áõ¥Êé•ËØ∑Ê±ÇÊåáÂÆöÈ¢òÂè∑
                const url = `/api/v1/questions?page=1&page_size=1&question_number=${val}`;
                fetch(url).then(r => r.json()).then(data => {
                    const list = data.questions || [];
                    const total = data.total || 0;
                    displayQuestions(list, total);
                    updatePaginationBar(1, 1, total);
                    updateExpectedCard(list.length, total);
                }).catch(() => {
                    showAlert('Êú™ÊâæÂà∞ËØ•È¢òÂè∑', 'error');
                });
            }
        }

        // ÊòæÁ§∫È¢òÁõÆÂàóË°®
        function displayQuestions(questions, total) {
            const questionsList = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                let emptyMessage = 'ÊöÇÊó†È¢òÁõÆÊï∞ÊçÆÔºåËØ∑ÂÖà‰∏ä‰º†ÊñáÊ°£ËøõË°åËß£Êûê';
                if (state.questionType && state.questionType.trim()) {
                    emptyMessage = `ÊöÇÊó†"${state.questionType}"Á±ªÂûãÁöÑÈ¢òÁõÆÊï∞ÊçÆ`;
                }
                questionsList.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">${emptyMessage}</div>`;
                return;
            }

            let displayText = '';
            if (state.questionType && state.questionType.trim()) {
                displayText = `"${state.questionType}"Á±ªÂûãÈ¢òÁõÆÔºåÂÖ± ${total} ÈÅìÔºõÁ¨¨ ${state.page} È°µ / ÊØèÈ°µ ${state.pageSize}`;
            } else if (state.search) {
                displayText = `ÊêúÁ¥¢ "${state.search}" ÁªìÊûúÔºöÂÖ± ${total} ÈÅìÔºõÁ¨¨ ${state.page} È°µ / ÊØèÈ°µ ${state.pageSize}`;
            } else {
                displayText = `ÊÄªÂÖ± ${total} ÈÅìÈ¢òÁõÆÔºõÁ¨¨ ${state.page} È°µ / ÊØèÈ°µ ${state.pageSize}`;
            }
            
            let html = `<div style="margin-bottom: 15px; color: #667eea; font-weight: bold; font-size: 1.1em;">${displayText}</div>`;
            
            // Â§ö‰∫é20Êù°Âä†ÊèêÁ§∫
            if (questions.length > 20) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffecb3; border-radius: 5px; color: #856404;">
                    üí° <strong>ÊèêÁ§∫:</strong> Â∑≤Âä†ËΩΩ${questions.length}ÈÅìÈ¢òÁõÆÔºåÈ°µÈù¢ÂÜÖÂÆπËæÉÂ§ö„ÄÇÂª∫ËÆÆ‰ΩøÁî®ÊµèËßàÂô®ÁöÑÊü•ÊâæÂäüËÉΩÔºàCtrl+F / Cmd+FÔºâÊù•Âø´ÈÄüÂÆö‰ΩçÁâπÂÆöÈ¢òÁõÆ„ÄÇ
                </div>`;
            }
            
            questions.forEach(question => {
                const typeClass = getTypeClass(question.question_type);
                html += `
                    <div class="question-item">
                        <div class="question-header">
                            <span class="question-number">Á¨¨${question.question_number}È¢ò</span>
                            <span class="question-type ${typeClass}">${question.question_type}</span>
                            <button onclick="viewQuestionDetail('${question.id}')" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Êü•ÁúãËØ¶ÊÉÖ</button>
                        </div>
                        <div class="question-meta">
                            üìù ÂõæÁâáÊï∞Èáè: ${question.total_images || 0}Âº† | 
                            üìÑ ÊÆµËêΩËåÉÂõ¥: ${question.paragraph_range || 'Êú™Áü•'} | 
                            üïí ÂàõÂª∫Êó∂Èó¥: ${question.created_at ? new Date(question.created_at).toLocaleString() : 'Êú™Áü•'}
                        </div>
                        <div id="detail-${question.id}" class="question-detail" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #667eea;">
                            <div class="loading-detail">Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆËØ¶ÊÉÖ...</div>
                        </div>
                    </div>
                `;
            });

            questionsList.innerHTML = html;
        }

        function updatePaginationBar() {
            const bar = document.getElementById('paginationBar');
            const info = document.getElementById('pageInfo');
            const prev = document.getElementById('prevPageBtn');
            const next = document.getElementById('nextPageBtn');
            if (!bar) return;
            const totalPages = Math.max(1, Math.ceil((state.total || 0) / state.pageSize));
            bar.style.display = totalPages > 1 ? 'block' : 'none';
            info.textContent = `Á¨¨ ${state.page} / ${totalPages} È°µÔºàÂÖ± ${state.total} ÈÅìÔºâ`;
            prev.disabled = state.page <= 1;
            next.disabled = state.page >= totalPages;
        }

        function prevPage() {
            if (state.page > 1) {
                state.page -= 1;
                reloadList();
            }
        }

        function nextPage() {
            const totalPages = Math.max(1, Math.ceil((state.total || 0) / state.pageSize));
            if (state.page < totalPages) {
                state.page += 1;
                reloadList();
            }
        }

        function updateExpectedCard(currentCount, total) {
            const node = document.getElementById('statTotalExpected');
            if (node) {
                node.textContent = `${currentCount}/${total}`;
            }
        }

        async function refreshStatsAndFilters() {
            try {
                const res = await fetch('/api/v1/questions/stats');
                const s = await res.json();
                // ÁªüËÆ°Êï∞Â≠ó
                const totalNode = document.querySelector('.stats .stat-card .stat-number');
                const allCards = document.querySelectorAll('.stats .stat-card .stat-number');
                if (allCards && allCards.length >= 2) {
                    allCards[0].textContent = s.total_questions;
                    allCards[1].textContent = s.total_extractions;
                }
                // È¢òÂûãÂàÜÂ∏É
                const typeBlock = document.getElementById('typeDistributionBlock');
                const typeContainer = document.getElementById('typeDistribution');
                const typeCountNode = document.getElementById('statTypeCount');
                const typeFilter = document.getElementById('typeFilter');
                // Âõ∫ÂÆöÈ¢òÂûãÂêçÁß∞‰∏éÂ±ïÁ§∫È°∫Â∫èÔºàÁ¨¨‰∏ÄÂà∞Á¨¨ÂÖ≠Â§ßÈ¢òÔºâ
                // 1. ÊîøÊ≤ªÁêÜËÆ∫ 2. Â∏∏ËØÜÂà§Êñ≠ 3. Ë®ÄËØ≠ÁêÜËß£‰∏éË°®Ëææ 4. Êï∞ÈáèÂÖ≥Á≥ª 5. Âà§Êñ≠Êé®ÁêÜ 6. ËµÑÊñôÂàÜÊûê
                const NORMALIZED_ORDER = ['ÊîøÊ≤ªÁêÜËÆ∫','Â∏∏ËØÜÂà§Êñ≠','Ë®ÄËØ≠ÁêÜËß£‰∏éË°®Ëææ','Êï∞ÈáèÂÖ≥Á≥ª','Âà§Êñ≠Êé®ÁêÜ','ËµÑÊñôÂàÜÊûê'];
                const normalizeName = (raw) => {
                    const t = String(raw || '');
                    if (t.includes('Ë®ÄËØ≠')) return 'Ë®ÄËØ≠ÁêÜËß£‰∏éË°®Ëææ';
                    if (t.includes('ËµÑÊñô')) return 'ËµÑÊñôÂàÜÊûê';
                    if (t.includes('Â∏∏ËØÜ')) return 'Â∏∏ËØÜÂà§Êñ≠';
                    if (t.includes('Âà§Êñ≠')) return 'Âà§Êñ≠Êé®ÁêÜ';
                    if (t.includes('Êï∞Èáè')) return 'Êï∞ÈáèÂÖ≥Á≥ª';
                    if (t.includes('ÊîøÊ≤ª')) return 'ÊîøÊ≤ªÁêÜËÆ∫';
                    return t || 'Êú™Áü•';
                };
                const counts = {};
                (s.type_distribution || []).forEach((t) => {
                    const name = normalizeName(t.type);
                    counts[name] = (counts[name] || 0) + (t.count || 0);
                });
                if (Array.isArray(s.type_distribution) && s.type_distribution.length > 0) {
                    typeBlock.style.display = 'block';
                    // ÊòæÁ§∫È¢òÂûãÂêçÁß∞‰∏éÊï∞Èáè
                    typeContainer.innerHTML = NORMALIZED_ORDER.map(n => {
                        const cnt = counts[n] || 0;
                        return `<div class="type-item"><strong>${n}</strong><div style="margin-top:6px;color:#666;">${cnt} ÈÅì</div></div>`;
                    }).join('');
                    if (typeCountNode) typeCountNode.textContent = NORMALIZED_ORDER.length;
                    // Êõ¥Êñ∞Á≠õÈÄâ‰∏ãÊãâ‰∏∫ËßÑËåÉÂåñÂêéÁöÑÈ¢òÂûãÂêç
                    const current = typeFilter.value;
                    typeFilter.innerHTML = '<option value="">üìö ÂÖ®ÈÉ®È¢òÂûã</option>' +
                        NORMALIZED_ORDER.filter(n => (counts[n] || 0) > 0)
                        .map(n => `<option value="${n}">${n}${counts[n] ? `Ôºà${counts[n]}Ôºâ` : ''}</option>`)
                        .join('');
                    typeFilter.value = current && [...typeFilter.options].some(o => o.value === current) ? current : '';
                } else {
                    typeBlock.style.display = 'none';
                    typeContainer.innerHTML = '';
                    if (typeCountNode) typeCountNode.textContent = '0';
                    // Ê∏ÖÁ©∫Á≠õÈÄâ
                    typeFilter.innerHTML = '<option value="">üìö ÂÖ®ÈÉ®È¢òÂûã</option>';
                }
            } catch (e) {
                // ÂøΩÁï•ÁªüËÆ°Â§±Ë¥•
            }

            // È¢òÂûãÊ¥ûÂØüÔºöÂ±ïÁ§∫ÂéüÂßãÂÄº‰∏éËßÑËåÉÊò†Â∞Ñ
            try {
                const res2 = await fetch('/api/v1/questions/type-insights');
                if (res2.ok) {
                    const t = await res2.json();
                    const block = document.getElementById('typeInsightsBlock');
                    const container = document.getElementById('typeInsights');
                    const rows = t.mappings || [];
                    if (rows.length > 0) {
                        block.style.display = 'block';
                        container.innerHTML = rows.map(r => {
                            const same = (r.raw === r.normalized);
                            const color = same ? '#2f855a' : '#c05621';
                            const tip = same ? 'Â∑≤ËßÑËåÉ' : 'ÈúÄÊ∏ÖÊ¥ó';
                            return `<div style="background:#fff; padding:12px; border-radius:8px; border-left:4px solid ${color};">
                                <div style="font-weight:600;">${r.raw}</div>
                                <div style="color:#666; font-size:12px;">‚Üí ${r.normalized} | <span style="color:${color}">${tip}</span></div>
                                <div style="margin-top:6px; color:#666;">${r.count} ÈÅì</div>
                            </div>`;
                        }).join('');
                    } else {
                        block.style.display = 'none';
                        container.innerHTML = '';
                    }
                }
            } catch {}
        }

        // Ëé∑ÂèñÈ¢òÂûãÂØπÂ∫îÁöÑCSSÁ±ª
        function getTypeClass(questionType) {
            if (!questionType) return '';
            if (questionType.includes('ÊîøÊ≤ª')) return 'type-politics';
            if (questionType.includes('Â∏∏ËØÜ')) return 'type-common';
            if (questionType.includes('Ë®ÄËØ≠')) return 'type-language';
            if (questionType.includes('Êï∞Èáè')) return 'type-math';
            if (questionType.includes('Âà§Êñ≠')) return 'type-logic';
            return '';
        }

        // Êü•ÁúãÈ¢òÁõÆËØ¶ÊÉÖ
        async function viewQuestionDetail(questionId) {
            const detailElement = document.getElementById(`detail-${questionId}`);
            
            // ÂàáÊç¢ÊòæÁ§∫/ÈöêËóè
            if (detailElement.style.display === 'block') {
                detailElement.style.display = 'none';
                return;
            }
            
            detailElement.style.display = 'block';
            detailElement.innerHTML = '<div class="loading-detail">Ê≠£Âú®Âä†ËΩΩÈ¢òÁõÆËØ¶ÊÉÖ...</div>';
            
            try {
                const response = await fetch(`/api/v1/questions/${questionId}`);
                if (response.ok) {
                    const questionData = response.json();
                    displayQuestionDetail(detailElement, await questionData);
                } else {
                    detailElement.innerHTML = '<div class="alert error">Âä†ËΩΩÈ¢òÁõÆËØ¶ÊÉÖÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈ¢òÁõÆËØ¶ÊÉÖÂ§±Ë¥•:', error);
                detailElement.innerHTML = '<div class="alert error">Âä†ËΩΩËØ¶ÊÉÖÂ§±Ë¥•: ' + error.message + '</div>';
            }
        }
        
        // ÊòæÁ§∫È¢òÁõÆËØ¶ÊÉÖÂÜÖÂÆπ
        async function displayQuestionDetail(container, questionData) {
            let content = questionData.content;
            
            // Â¶ÇÊûúcontentÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËß£ÊûêJSON
            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    console.error('Ëß£Êûêcontent JSONÂ§±Ë¥•:', e);
                    container.innerHTML = '<div class="alert error">È¢òÁõÆÂÜÖÂÆπÊ†ºÂºèÈîôËØØ</div>';
                    return;
                }
            }
            
            let allImages = Array.isArray(questionData.images) ? questionData.images : [];
            const optionRe = /^[A-DÔº°-Ôº§][\s\t]*[„ÄÅ\.Ôºé\)]/;
            let materialImgs = allImages.filter(img => (img.image_type === 'material') || (!img.image_type && !optionRe.test((img.context_text||'').trim())));
            let optionImgs = allImages.filter(img => (img.image_type === 'option') || optionRe.test((img.context_text||'').trim()));
            // Â∞ÜÈÄâÈ°πÂõæÁâáÊåâÊÆµËêΩÁ¥¢ÂºïÂàÜÁªÑÔºå‰æø‰∫éÂÜÖËÅîÂà∞ÂØπÂ∫îÈÄâÈ°π
            const imgsByParaIndex = {};
            (optionImgs || []).forEach(img => {
                const idx = Number(img.paragraph_index ?? -1);
                if (idx >= 0) {
                    if (!imgsByParaIndex[idx]) imgsByParaIndex[idx] = [];
                    imgsByParaIndex[idx].push(img);
                }
            });
            const embeddedOptionUrls = new Set();

            // ËµÑÊñôÂàÜÊûêÔºö‰∏∫ÁªÑÂÜÖÈùûÈ¶ñÈ¢òËá™Âä®Ë°•ÂÖÖÊú¨ÁªÑÈ¢òÂπ≤ÊùêÊñôÔºàÂèñÁªÑÈ¶ñÈ¢òÁöÑÊùêÊñôÂõæÔºâ
            try {
                if ((questionData.question_type || '').includes('ËµÑÊñôÂàÜÊûê')) {
                    const qn = Number(questionData.question_number || 0);
                    if (qn && (qn - 1) % 5 !== 0) {
                        const groupStart = qn - ((qn - 1) % 5);
                        const listRes = await fetch(`/api/v1/questions?page=1&page_size=1&question_number=${groupStart}`);
                        if (listRes.ok) {
                            const listJson = await listRes.json();
                            const leader = (listJson.questions && listJson.questions[0]) ? listJson.questions[0] : null;
                            if (leader && leader.id) {
                                const leaderRes = await fetch(`/api/v1/questions/${leader.id}`);
                                if (leaderRes.ok) {
                                    const leaderDetail = await leaderRes.json();
                                    const leaderImgs = Array.isArray(leaderDetail.images) ? leaderDetail.images : [];
                                    const leaderMaterials = leaderImgs.filter(img => (img.image_type === 'material') || (!img.image_type && !optionRe.test((img.context_text || '').trim())));
                                    if (materialImgs.length === 0 && leaderMaterials.length > 0) {
                                        const existNames = new Set(materialImgs.map(i => i.url));
                                        leaderMaterials.forEach(i => { if (!existNames.has(i.url)) materialImgs.push(i); });
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (e) { /* ÂøΩÁï•Ë°•ÂÖÖÊùêÊñôÂ§±Ë¥• */ }

            let html = `
                <div style="margin-bottom: 15px;">
                    <h4>üìã È¢òÁõÆ ${questionData.question_number} ËØ¶ÁªÜÂÜÖÂÆπ</h4>
                    <p><strong>È¢òÂûã:</strong> ${questionData.question_type}</p>
                    <p><strong>ÊÆµËêΩËåÉÂõ¥:</strong> ${questionData.paragraph_range}</p>
                    <p><strong>ÂõæÁâáÁªüËÆ°:</strong> ÊùêÊñôÂõæ ${questionData.total_images || 0} Âº† | ÈÄâÈ°πÂõæ ${optionImgs.length} Âº†</p>
                </div>
            `;
            
            // ÊùêÊñôÂõæÁâá‰ºòÂÖàÂ±ïÁ§∫
            if (materialImgs.length > 0) {
                html += `
                    <div style="margin-bottom: 16px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2b6cb0;">
                        <h5 style="color: #2b6cb0; margin-bottom: 10px;">üìö È¢òÂπ≤ÊùêÊñôÂõæÁâá (${materialImgs.length}Âº†)</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                `;
                materialImgs.forEach((image, idx) => {
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: white;">
                            <div style="text-align: center; margin-bottom: 6px;">
                                <img src="${image.url}" alt="ÊùêÊñôÂõæ ${idx + 1}" style="max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 4px; cursor: pointer;" onclick="window.open('${image.url}', '_blank')" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22100%22%20height%3D%22100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23f0f0f0%22/%3E%3Ctext%20x%3D%2250%22%20y%3D%2255%22%20text-anchor%3D%22middle%22%20fill%3D%22%23999%22%20font-size%3D%2212%22%3E%E5%8A%A0%E8%BD%BD%E5%A4%B1%E8%B4%A5%3C/text%3E%3C/svg%3E'; this.onclick=null;">
                            </div>
                            <div style="font-size: 11px; color: #666; text-align: center;">ÊùêÊñôÂõæ ${idx + 1} | ÊÆµËêΩ ${image.paragraph_index + 1}</div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // ‰øùÁïôÂÖúÂ∫ïÊèêÁ§∫ÔºöËã•ÁªüËÆ°ÊúâÂõæ‰ΩÜÊú™ÊèêÂèñÂà∞ÈÄâÈ°πÂõæ
            if (optionImgs.length === 0 && (questionData.total_images || 0) > 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffecb3; border-radius: 5px; color: #856404;">
                        üì∑ <strong>Ê≥®ÊÑè:</strong> Ê≠§È¢òÁõÆÂåÖÂê´ ${questionData.total_images} Âº†ÂõæÁâáÔºå‰ΩÜÂõæÁâáÊï∞ÊçÆÊú™ËÉΩÊèêÂèñ„ÄÇÂèØËÉΩÈúÄË¶ÅÈáçÊñ∞‰∏ä‰º†ÊñáÊ°£Êù•Ëé∑ÂèñÂõæÁâá„ÄÇ
                    </div>
                `;
            }
            
            html += '<div class="question-content">';
            
            if (content && content.paragraphs && Array.isArray(content.paragraphs)) {
                html += '<div style="margin-bottom:10px;">'
                    + '<button onclick="toggleAllParagraphs(this)" style="background:#667eea;color:#fff;border:none;padding:6px 10px;border-radius:4px;margin-right:8px;">ÂÖ®ÈÉ®Â±ïÂºÄ</button>'
                    + '<button onclick="copyQuestionText(this)" style="background:#6c757d;color:#fff;border:none;padding:6px 10px;border-radius:4px;">Â§çÂà∂ÂÖ®Êñá</button>'
                    + '</div>';

                content.paragraphs.forEach((para, index) => {
                    if (para.text && para.text.trim()) {
                        const preview = (para.text.length > 120) ? (para.text.slice(0, 120) + '...') : para.text;
                        const collapsed = para.text.length > 120;
                        const isOptionPara = optionRe.test((para.text || '').trim());
                        let optionInlineHtml = '';
                        if (isOptionPara) {
                            const imgs = imgsByParaIndex[para.paragraph_index] || [];
                            if (imgs.length > 0) {
                                optionInlineHtml += '<div class="option-inline-images" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">';
                                imgs.forEach(img => {
                                    embeddedOptionUrls.add(img.url);
                                    optionInlineHtml += `<img src="${img.url}" alt="ÈÄâÈ°πÂõæ" style="max-width:140px; max-height:140px; object-fit:contain; border:1px solid #e5e7eb; border-radius:6px; padding:4px; background:#fff; cursor:pointer;" onclick="window.open('${img.url}','_blank')" onerror="this.style.display='none'">`;
                                });
                                optionInlineHtml += '</div>';
                            }
                        }
                        html += `
                            <div class="para-item" data-full="${encodeURIComponent(para.text)}" style="margin: 10px 0; padding: 8px; background: white; border-radius: 3px; border: 1px solid #eee;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                  <div style="font-size: 12px; color: #666;">
                                      ÊÆµËêΩ${index + 1} | ${para.images_count || 0}Âº†ÂõæÁâá | ${para.text_length || para.text.length}Â≠óÁ¨¶
                                  </div>
                                  <button class="toggle-btn" onclick="toggleParagraph(this)" style="background:#e2e8f0;color:#333;border:none;padding:4px 8px;border-radius:4px;font-size:12px;">${collapsed ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑'}</button>
                                </div>
                                <div class="para-text" data-collapsed="${collapsed}" style="line-height: 1.5; word-wrap: break-word; margin-top:6px;">${collapsed ? preview : para.text}</div>
                                ${optionInlineHtml}
                            </div>
                        `;
                    }
                });
                
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
                        <strong>üìä ÁªüËÆ°‰ø°ÊÅØ:</strong><br>
                        ÊÄªÊÆµËêΩÊï∞: ${content.paragraph_count || content.paragraphs.length}<br>
                        ÊÄªÂõæÁâáÊï∞: ${content.total_images || 0}Âº†<br>
                        ÊÄªÊñáÂ≠óÈïøÂ∫¶: ${content.total_text_length || 0}Â≠óÁ¨¶
                    </div>
                `;

                // Ëã•ËøòÊúâÊú™ËÉΩÂÜÖËÅîÂà∞ÈÄâÈ°πÊÆµËêΩÁöÑÂõæÁâáÔºå‰Ωú‰∏∫ÂÖúÂ∫ïÂ±ïÁ§∫Âú®ËøôÈáå
                const leftover = (optionImgs || []).filter(img => !embeddedOptionUrls.has(img.url));
                if (leftover.length > 0) {
                    html += `
                        <div style="margin-top: 16px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #38a169;">
                            <h5 style="color: #38a169; margin-bottom: 10px;">üî† ÈÄâÈ°πÂõæÁâáÔºàÂâ©‰Ωô${leftover.length}Âº†ÔºåÊú™ËÉΩÂÆö‰ΩçÂà∞ÂÖ∑‰ΩìÈÄâÈ°πÂ§ÑÔºâ</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                    `;
                    leftover.forEach(image => {
                        const ctx = (image.context_text || '').trim();
                        const label = ctx ? ctx.replace(/\s+/g,'').slice(0,1).replace('Ôº°','A').replace('Ôº¢','B').replace('Ôº£','C').replace('Ôº§','D') : '';
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: white;">
                                <div style="text-align: center; margin-bottom: 6px;">
                                    <img src="${image.url}" alt="ÈÄâÈ°π${label}" style="max-width: 100%; max-height: 160px; object-fit: contain; border-radius: 4px; cursor: pointer;" onclick="window.open('${image.url}', '_blank')" onerror="this.style.display='none'">
                                </div>
                                <div style="font-size: 11px; color: #666; text-align: center;">ÈÄâÈ°π ${label || '?'} ${ctx ? '<br>‰∏ä‰∏ãÊñá: ' + ctx.substring(0, 30) + (ctx.length > 30 ? '...' : '') : ''}</div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }
            } else {
                html += '<div style="color: #666; text-align: center; padding: 20px;">ÊöÇÊó†ËØ¶ÁªÜÂÜÖÂÆπÊàñÂÜÖÂÆπÊ†ºÂºèÂºÇÂ∏∏</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleParagraph(button) {
            const item = button.closest('.para-item');
            const textNode = item.querySelector('.para-text');
            const collapsed = textNode.getAttribute('data-collapsed') === 'true';
            if (collapsed) {
                textNode.textContent = decodeURIComponent(item.getAttribute('data-full'));
                textNode.setAttribute('data-collapsed', 'false');
                button.textContent = 'Êî∂Ëµ∑';
            } else {
                const full = decodeURIComponent(item.getAttribute('data-full'));
                const preview = full.length > 120 ? (full.slice(0,120)+'...') : full;
                textNode.textContent = preview;
                textNode.setAttribute('data-collapsed', 'true');
                button.textContent = 'Â±ïÂºÄ';
            }
        }

        function toggleAllParagraphs(btn) {
            const container = btn.closest('.question-detail');
            const items = container.querySelectorAll('.para-item');
            const expand = btn.textContent.includes('Â±ïÂºÄ');
            items.forEach(item => {
                const textNode = item.querySelector('.para-text');
                const toggleBtn = item.querySelector('.toggle-btn');
                const full = decodeURIComponent(item.getAttribute('data-full'));
                if (expand) {
                    textNode.textContent = full;
                    textNode.setAttribute('data-collapsed', 'false');
                    toggleBtn.textContent = 'Êî∂Ëµ∑';
                } else {
                    const preview = full.length > 120 ? (full.slice(0,120)+'...') : full;
                    textNode.textContent = preview;
                    textNode.setAttribute('data-collapsed', 'true');
                    toggleBtn.textContent = 'Â±ïÂºÄ';
                }
            });
            btn.textContent = expand ? 'ÂÖ®ÈÉ®Êî∂Ëµ∑' : 'ÂÖ®ÈÉ®Â±ïÂºÄ';
        }

        function copyQuestionText(btn) {
            const container = btn.closest('.question-detail');
            const texts = [...container.querySelectorAll('.para-item')].map(it => decodeURIComponent(it.getAttribute('data-full')));
            const all = texts.join('\n\n');
            navigator.clipboard.writeText(all).then(() => {
                showAlert('Â∑≤Â§çÂà∂È¢òÁõÆÂÖ®Êñá', 'success');
            }).catch(() => {
                showAlert('Â§çÂà∂Â§±Ë¥•', 'error');
            });
        }

        // ÊòæÁ§∫Ê∏ÖÁ©∫È¢òÂ∫ìÂØπËØùÊ°Ü
        function showClearDialog() {
            const message = `‚ö†Ô∏è  Âç±Èô©Êìç‰ΩúÁ°ÆËÆ§\n\n` +
                          `Âç≥Â∞ÜÊ∏ÖÁ©∫ÊâÄÊúâÈ¢òÂ∫ìÊï∞ÊçÆÔºåÂåÖÊã¨Ôºö\n` +
                          `‚Ä¢ ÊâÄÊúâÈ¢òÁõÆÊñáÊú¨ÂÜÖÂÆπ\n` +
                          `‚Ä¢ ÊâÄÊúâÂõæÁâáÊñá‰ª∂\n` +
                          `‚Ä¢ È¢òÁõÆÂàÜÁ±ªÂíåÂÖÉ‰ø°ÊÅØ\n\n` +
                          `Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`;
                          
            if (confirm(message)) {
                // ËØ¢ÈóÆÊòØÂê¶ÂêåÊó∂Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩï
                const clearHistory = confirm(
                    `ÊòØÂê¶ÂêåÊó∂Ê∏ÖÁ©∫ÊèêÂèñÂéÜÂè≤ËÆ∞ÂΩïÔºü\n\n` +
                    `‚Ä¢ ÈÄâÊã©"Á°ÆÂÆö"ÔºöÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÔºàÂåÖÊã¨ÂéÜÂè≤ËÆ∞ÂΩïÔºâ\n` +
                    `‚Ä¢ ÈÄâÊã©"ÂèñÊ∂à"Ôºö‰øùÁïôÂéÜÂè≤ËÆ∞ÂΩïÔºå‰ªÖÊ∏ÖÁ©∫È¢òÁõÆÊï∞ÊçÆ`
                );
                
                clearAllQuestions(clearHistory);
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâÈ¢òÁõÆ
        async function clearAllQuestions(clearHistory = false) {
            const clearButton = document.getElementById('clearAllButton');
            
            // Á¶ÅÁî®ÊåâÈíÆ
            clearButton.disabled = true;
            clearButton.innerHTML = 'üîÑ Ê∏ÖÁ©∫‰∏≠...';
            
            try {
                const response = await fetch(`/api/v1/questions/clear-all?clear_history=${clearHistory}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const stats = result.statistics;
                    showAlert(
                        `üéâ È¢òÂ∫ìÊ∏ÖÁ©∫ÊàêÂäüÔºÅ\\n\\n` +
                        `üìä Ê∏ÖÁêÜÁªüËÆ°:\\n` +
                        `‚Ä¢ Âà†Èô§È¢òÁõÆÔºö${stats.deleted_questions}ÈÅì\\n` +
                        `‚Ä¢ Âà†Èô§ÂõæÁâáËÆ∞ÂΩïÔºö${stats.deleted_images_records}Êù°\\n` +
                        `‚Ä¢ Âà†Èô§ÂõæÁâáÊñá‰ª∂Ôºö${stats.deleted_image_files}‰∏™\\n` +
                        `${stats.history_cleared ? '‚Ä¢ Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩïÔºö' + stats.deleted_history + 'Êù°\\n' : ''}\\n` +
                        `‚úÖ È¢òÂ∫ìÂ∑≤ÂÆåÂÖ®Ê∏ÖÁ©∫ÔºåÂèØ‰ª•ÈáçÊñ∞ÂØºÂÖ•Êï∞ÊçÆ‰∫ÜÔºÅ`,
                        'success'
                    );
                    
                    // 2ÁßíÂêéÂà∑Êñ∞È°µÈù¢
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                    
                } else {
                    throw new Error(result.detail || result.message || 'Ê∏ÖÁ©∫Â§±Ë¥•');
                }
                
            } catch (error) {
                console.error('Ê∏ÖÁ©∫È¢òÂ∫ìÂ§±Ë¥•:', error);
                showAlert('Ê∏ÖÁ©∫È¢òÂ∫ìÂ§±Ë¥•: ' + error.message, 'error');
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                clearButton.disabled = false;
                clearButton.innerHTML = 'üóëÔ∏è Ê∏ÖÁ©∫È¢òÂ∫ì';
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(message, type) {
            const uploadResult = document.getElementById('uploadResult');
            const alertClass = type === 'success' ? 'success' : 'error';
            
            uploadResult.innerHTML = `<div class="alert ${alertClass}">${message.replace(/\\n/g, '<br>')}</div>`;
            
            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑÊòæÁ§∫Êó∂Èó¥
            const displayTime = type === 'success' ? 8000 : 5000;
            setTimeout(() => {
                uploadResult.innerHTML = '';
            }, displayTime);
        }
    </script>
</body>
</html>



