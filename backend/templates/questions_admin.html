<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š é¢˜ç›®åº“ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #e8f0fe;
        }

        .upload-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1.1em;
        }

        .file-input-button:hover {
            background: #5a67d8;
        }

        .upload-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .upload-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .questions-section {
            margin-top: 30px;
        }

        .questions-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .question-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .question-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .question-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .question-meta {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .question-images {
            margin: 10px 0;
        }

        .question-images img {
            max-width: 200px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .type-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .type-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .recent-extractions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .extraction-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .extraction-item.success {
            border-color: #28a745;
        }

        .extraction-item.error {
            border-color: #dc3545;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .questions-section h2 {
            position: relative;
        }
        
        .questions-controls {
            position: sticky;
            top: 0;
            background: #ffffff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .questions-controls button {
            padding: 5px 15px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .questions-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .questions-controls select {
            padding: 5px 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .questions-controls select:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }
        
        .questions-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .questions-controls input[type="text"],
        .questions-controls input[type="number"] {
            padding: 5px 10px;
            margin-right: 4px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .danger-section {
            background: #fff5f5;
            border: 2px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .danger-section h3 {
            color: #e53e3e;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .danger-button {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .danger-button:hover {
            background: linear-gradient(45deg, #c53030, #9c2626);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }
        
        .danger-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .questions-controls {
                float: none;
                margin-top: 10px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .questions-controls select {
                margin-right: 0;
                width: 100%;
            }
            
            .questions-controls button {
                display: block;
                width: 100%;
                margin: 0;
            }
            
            .danger-section {
                padding: 15px;
            }
            
            .danger-section h3 {
                font-size: 1.1em;
            }
            
            .danger-button {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“š é¢˜ç›®åº“ç®¡ç†ç³»ç»Ÿ</h1>
            <p>åŸºäºäººç±»é€»è¾‘çš„æ™ºèƒ½é¢˜ç›®æå– | æˆåŠŸç‡90-95%</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ total_questions }}</div>
                <div class="stat-label">é¢˜ç›®æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_extractions }}</div>
                <div class="stat-label">æå–æ¬¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTypeCount">--</div>
                <div class="stat-label">é¢˜ç›®ç±»å‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statTotalExpected">--</div>
                <div class="stat-label">å½“å‰æ˜¾ç¤º/æ€»æ•°</div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- é¢˜å‹åˆ†å¸ƒ -->
            <div class="recent-extractions" id="typeDistributionBlock" style="display:none;">
                <h3>ğŸ“Š é¢˜å‹åˆ†å¸ƒ</h3>
                <div class="type-distribution" id="typeDistribution"></div>
            </div>

            <!-- é¢˜å‹æ¸…æ´—å»ºè®®/åŸå§‹ç±»å‹ -->
            <div class="recent-extractions" id="typeInsightsBlock" style="display:none;">
                <h3>ğŸ§¹ é¢˜å‹æ¸…æ´—å»ºè®®</h3>
                <div id="typeInsights" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px;"></div>
            </div>

            <!-- æ–‡æ¡£ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <h2>ğŸ“„ æ–‡æ¡£ä¸Šä¼ ä¸è§£æ</h2>
                <p>æ”¯æŒä¸Šä¼  .docx æ ¼å¼çš„å…¬åŠ¡å‘˜è€ƒè¯•é¢˜ç›®æ–‡æ¡£</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".docx">
                    <label for="fileInput" class="file-input-button">
                        ğŸ—‚ï¸ é€‰æ‹©æ–‡ä»¶
                    </label>
                </div>
                
                <button id="uploadButton" class="upload-button" disabled>
                    ğŸš€ å¼€å§‹è§£æ
                </button>

                <div id="progress" class="progress">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨è§£ææ–‡æ¡£ï¼Œè¯·ç¨å€™...</div>
                    </div>
                </div>

                <div id="uploadResult"></div>
            </div>

            <!-- æœ€è¿‘æå–è®°å½• -->
            {% if recent_extractions %}
            <div class="recent-extractions">
                <h3>ğŸ“ˆ æœ€è¿‘æå–è®°å½•</h3>
                {% for extraction in recent_extractions %}
                <div class="extraction-item {{ 'success' if extraction.success else 'error' }}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ extraction.filename }}</strong>
                            <br>
                            <small>
                                é¢˜ç›®: {{ extraction.total_questions_extracted or 0 }}é“ | 
                                å›¾ç‰‡: {{ extraction.total_images_extracted or 0 }}å¼  | 
                                ç”¨æ—¶: {{ extraction.processing_time_seconds or 0 }}ç§’
                            </small>
                        </div>
                        <div style="color: {{ '#28a745' if extraction.success else '#dc3545' }};">
                            {{ 'âœ… æˆåŠŸ' if extraction.success else 'âŒ å¤±è´¥' }}
                        </div>
                    </div>
                    {% if not extraction.success and extraction.error_message %}
                    <div style="color: #dc3545; font-size: 0.9em; margin-top: 5px;">
                        é”™è¯¯: {{ extraction.error_message }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ç®¡ç†æ“ä½œåŒºåŸŸ -->
            <div class="danger-section">
                <h3>âš ï¸ å±é™©æ“ä½œåŒºåŸŸ</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    ä»¥ä¸‹æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼æ¸…ç©ºåæ‰€æœ‰é¢˜ç›®ã€å›¾ç‰‡å’Œç›¸å…³æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚
                </p>
                <div>
                    <button id="clearAllButton" onclick="showClearDialog()" class="danger-button" title="æ¸…ç©ºæ‰€æœ‰é¢˜ç›®å’Œå›¾ç‰‡æ•°æ®">
                        ğŸ—‘ï¸ æ¸…ç©ºé¢˜åº“
                    </button>
                    <span style="color: #666; font-size: 12px; margin-left: 10px;">
                        å»ºè®®åœ¨é‡æ–°å¯¼å…¥é¢˜ç›®å‰ä½¿ç”¨æ­¤åŠŸèƒ½
                    </span>
                </div>
            </div>

            <!-- é¢˜ç›®åˆ—è¡¨ -->
            <div class="questions-section">
                <h2>ğŸ“‹ é¢˜ç›®åˆ—è¡¨</h2>
                <div class="questions-controls">
                    <select id="typeFilter" onchange="onTypeFilterChange()" title="æŒ‰é¢˜å‹ç­›é€‰">
                        <option value="">ğŸ“š å…¨éƒ¨é¢˜å‹</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="æœç´¢å…³é”®è¯..." onkeydown="if(event.key==='Enter'){onSearch()}" />
                    <input type="number" id="jumpInput" placeholder="è·³åˆ°é¢˜å·" min="1" style="width:100px;" onkeydown="if(event.key==='Enter'){onJump()}" />
                    <select id="sortSelect" onchange="onSortChange()" title="æ’åº">
                        <option value="number-asc">é¢˜å· â†‘</option>
                        <option value="number-desc">é¢˜å· â†“</option>
                        <option value="created_at-desc">æœ€æ–°åˆ›å»º</option>
                        <option value="created_at-asc">æœ€æ—©åˆ›å»º</option>
                    </select>
                    <select id="pageSizeSelect" onchange="onPageSizeChange()" title="æ¯é¡µæ•°é‡">
                        <option value="10">æ¯é¡µ10</option>
                        <option value="20" selected>æ¯é¡µ20</option>
                        <option value="50">æ¯é¡µ50</option>
                    </select>
                    <button onclick="reloadList()" style="background: #6c757d;" title="åˆ·æ–°é¢˜ç›®åˆ—è¡¨">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="questionsList">
                    <div class="loading" id="questionsLoading">
                        <div class="spinner"></div>
                        <div>æ­£åœ¨åŠ è½½é¢˜ç›®åˆ—è¡¨...</div>
                    </div>
                    {% if ssr_questions and ssr_questions|length > 0 %}
                    <div id="ssrFallback" style="padding:10px 0;">
                        <div style="margin-bottom: 10px; color:#999; font-size:12px;">ï¼ˆé¦–å±æœåŠ¡ç«¯æ¸²æŸ“ï¼ŒJSåŠ è½½åå°†è‡ªåŠ¨åˆ·æ–°ï¼‰</div>
                        {% for q in ssr_questions %}
                        <div class="question-item">
                            <div class="question-header">
                                <span class="question-number">ç¬¬{{ q.question_number }}é¢˜</span>
                                <span class="question-type">{{ q.question_type }}</span>
                                <button onclick="viewQuestionDetail('{{ q.id }}')" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">æŸ¥çœ‹è¯¦æƒ…</button>
                            </div>
                            <div class="question-meta">
                                ğŸ“ å›¾ç‰‡æ•°é‡: {{ q.total_images or 0 }}å¼  | ğŸ“„ æ®µè½èŒƒå›´: {{ q.paragraph_range or 'æœªçŸ¥' }} | ğŸ•’ åˆ›å»ºæ—¶é—´: {{ q.created_at or 'æœªçŸ¥' }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div id="paginationBar" style="display:none; text-align:center; margin-top:10px;">
                    <button id="prevPageBtn" onclick="prevPage()" style="background:#667eea;">ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo" style="margin:0 10px; color:#666;"></span>
                    <button id="nextPageBtn" onclick="nextPage()" style="background:#667eea;">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentFile = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', function(e) {
                currentFile = e.target.files[0];
                const uploadButton = document.getElementById('uploadButton');
                
                if (currentFile && currentFile.name.endsWith('.docx')) {
                    uploadButton.disabled = false;
                    uploadButton.innerHTML = 'ğŸš€ å¼€å§‹è§£æ ' + currentFile.name;
                } else {
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = 'ğŸš€ å¼€å§‹è§£æ';
                    if (currentFile) {
                        showAlert('è¯·é€‰æ‹© .docx æ ¼å¼çš„æ–‡ä»¶', 'error');
                    }
                }
            });

            // ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            document.getElementById('uploadButton').addEventListener('click', uploadDocument);

            // åˆå§‹åŒ–ç»Ÿè®¡ä¸ç­›é€‰
            refreshStatsAndFilters();
            // åŠ è½½é¢˜ç›®åˆ—è¡¨
            reloadList();
        });

        // ä¸Šä¼ æ–‡æ¡£å‡½æ•°
        async function uploadDocument() {
            if (!currentFile) {
                showAlert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            const uploadButton = document.getElementById('uploadButton');
            const progress = document.getElementById('progress');
            const loading = progress.querySelector('.loading');
            
            // æ˜¾ç¤ºè¿›åº¦
            uploadButton.disabled = true;
            uploadButton.innerHTML = 'â³ è§£æä¸­...';
            progress.classList.add('show');
            if (loading) {
                loading.style.display = 'block';
            }

            const formData = new FormData();
            formData.append('file', currentFile);

            try {
                const response = await fetch('/api/v1/questions/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert(
                        `ğŸ‰ è§£ææˆåŠŸï¼\\n` +
                        `ğŸ“Š æå–é¢˜ç›®: ${result.questions_count}é“\\n` +
                        `ğŸ–¼ï¸ ç»Ÿè®¡å›¾ç‰‡: ${result.images_count}å¼ \\n` +
                        `ğŸ’¾ ä¿å­˜å›¾ç‰‡: ${result.images_saved || 0}å¼ \\n` +
                        `â±ï¸ å¤„ç†æ—¶é—´: ${result.processing_time}ç§’\\n` +
                        `âœ… å·²ä¿å­˜: ${result.questions_saved}é“é¢˜ç›®`,
                        'success'
                    );
                    
                    // æ˜¾ç¤ºéªŒè¯ç»“æœ
                    if (result.validation && result.validation.issues.length > 0) {
                        showAlert('å‘ç°çš„é—®é¢˜:\\n' + result.validation.issues.join('\\n'), 'error');
                    }
                    
                    // åˆ·æ–°ç»Ÿè®¡ä¸åˆ—è¡¨ï¼ˆä¸æ•´é¡µåˆ·æ–°ï¼‰
                    await refreshStatsAndFilters();
                    await reloadList();
                } else {
                    throw new Error(result.detail || result.message || 'è§£æå¤±è´¥');
                }

            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showAlert('è§£æå¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'ğŸš€ å¼€å§‹è§£æ';
                if (loading) {
                    loading.style.display = 'none';
                }
                progress.classList.remove('show');
                
                // æ¸…é™¤æ–‡ä»¶é€‰æ‹©
                document.getElementById('fileInput').value = '';
                currentFile = null;
            }
        }

        // åˆ—è¡¨æŸ¥è¯¢çŠ¶æ€
        let state = {
            page: 1,
            pageSize: 20,
            questionType: '',
            search: '',
            sortBy: 'number',
            order: 'asc',
            total: 0
        };

        function buildQuery() {
            const params = new URLSearchParams();
            params.set('page', String(state.page));
            params.set('page_size', String(state.pageSize));
            if (state.questionType) params.set('question_type', state.questionType);
            if (state.search) params.set('search', state.search);
            params.set('sort_by', state.sortBy);
            params.set('order', state.order);
            return params.toString();
        }

        async function reloadList() {
            await loadQuestions();
        }

        // åŠ è½½é¢˜ç›®åˆ—è¡¨
        async function loadQuestions() {
            const questionsList = document.getElementById('questionsList');
            const loading = document.getElementById('questionsLoading');
            
            // ä»æ§ä»¶è¯»å–å½“å‰çŠ¶æ€
            const typeFilter = document.getElementById('typeFilter');
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            
            state.questionType = typeFilter ? typeFilter.value : '';
            state.search = searchInput ? (searchInput.value || '') : '';
            if (sortSelect) {
                const [key, dir] = sortSelect.value.split('-');
                state.sortBy = key === 'created_at' ? 'created_at' : 'number';
                state.order = dir === 'desc' ? 'desc' : 'asc';
            }
            if (pageSizeSelect) {
                state.pageSize = parseInt(pageSizeSelect.value || '20', 10);
            }
            
            // æ£€æŸ¥loadingå…ƒç´ æ˜¯å¦å­˜åœ¨
            if (loading) {
                loading.style.display = 'block';
                let loadingText = '';
                if (state.questionType) {
                    loadingText = `æ­£åœ¨åŠ è½½${state.questionType}é¢˜ç›®...`;
                } else {
                    loadingText = `æ­£åœ¨åŠ è½½ç¬¬ ${state.page} é¡µ...`;
                }
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <div>${loadingText}</div>
                `;
            }

            try {
                const url = `/api/v1/questions?${buildQuery()}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.questions) {
                    state.total = data.total || 0;
                    // å½“é¡µç è¶…å‡ºèŒƒå›´å¯¼è‡´ç©ºåˆ—è¡¨æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°æœ€åä¸€é¡µå¹¶é‡è½½ï¼Œé¿å…â€œæ€»æ•°>0ä½†æ— æ•°æ®â€çš„å‡ç©ºçŠ¶æ€
                    const totalPages = Math.max(1, Math.ceil((state.total) / Math.max(1, state.pageSize)));
                    if ((state.total > 0) && (!Array.isArray(data.questions) || data.questions.length === 0) && state.page > totalPages) {
                        state.page = totalPages;
                        return await loadQuestions();
                    }

                    displayQuestions(data.questions, data.total);
                    updatePaginationBar();
                    updateExpectedCard(data.questions.length, data.total);
                } else {
                    questionsList.innerHTML = '<div class="alert error">åŠ è½½é¢˜ç›®åˆ—è¡¨å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                questionsList.innerHTML = '<div class="alert error">åŠ è½½é¢˜ç›®åˆ—è¡¨å¤±è´¥: ' + error.message + '</div>';
            } finally {
                if (loading) {
                    loading.style.display = 'none';
                }
            }
        }

        // æœç´¢
        function onSearch() {
            state.page = 1;
            reloadList();
        }

        // é¢˜å‹ç­›é€‰å˜åŒ–å¤„ç†
        function onTypeFilterChange() {
            state.page = 1;
            reloadList();
        }

        // æ’åº
        function onSortChange() {
            state.page = 1;
            reloadList();
        }

        // æ¯é¡µæ•°é‡
        function onPageSizeChange() {
            state.page = 1;
            reloadList();
        }

        // è·³è½¬é¢˜å·
        function onJump() {
            const jumpInput = document.getElementById('jumpInput');
            const val = parseInt(jumpInput.value || '0', 10);
            if (val > 0) {
                state.search = '';
                state.questionType = '';
                state.sortBy = 'number';
                state.order = 'asc';
                // ç›´æ¥è¯·æ±‚æŒ‡å®šé¢˜å·
                const url = `/api/v1/questions?page=1&page_size=1&question_number=${val}`;
                fetch(url).then(r => r.json()).then(data => {
                    const list = data.questions || [];
                    const total = data.total || 0;
                    displayQuestions(list, total);
                    updatePaginationBar(1, 1, total);
                    updateExpectedCard(list.length, total);
                }).catch(() => {
                    showAlert('æœªæ‰¾åˆ°è¯¥é¢˜å·', 'error');
                });
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®åˆ—è¡¨
        function displayQuestions(questions, total) {
            const questionsList = document.getElementById('questionsList');
            
            if (questions.length === 0) {
                let emptyMessage = 'æš‚æ— é¢˜ç›®æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æ–‡æ¡£è¿›è¡Œè§£æ';
                if (state.questionType && state.questionType.trim()) {
                    emptyMessage = `æš‚æ— "${state.questionType}"ç±»å‹çš„é¢˜ç›®æ•°æ®`;
                }
                questionsList.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">${emptyMessage}</div>`;
                return;
            }

            let displayText = '';
            if (state.questionType && state.questionType.trim()) {
                displayText = `"${state.questionType}"ç±»å‹é¢˜ç›®ï¼Œå…± ${total} é“ï¼›ç¬¬ ${state.page} é¡µ / æ¯é¡µ ${state.pageSize}`;
            } else if (state.search) {
                displayText = `æœç´¢ "${state.search}" ç»“æœï¼šå…± ${total} é“ï¼›ç¬¬ ${state.page} é¡µ / æ¯é¡µ ${state.pageSize}`;
            } else {
                displayText = `æ€»å…± ${total} é“é¢˜ç›®ï¼›ç¬¬ ${state.page} é¡µ / æ¯é¡µ ${state.pageSize}`;
            }
            
            let html = `<div style="margin-bottom: 15px; color: #667eea; font-weight: bold; font-size: 1.1em;">${displayText}</div>`;
            
            // å¤šäº20æ¡åŠ æç¤º
            if (questions.length > 20) {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffecb3; border-radius: 5px; color: #856404;">
                    ğŸ’¡ <strong>æç¤º:</strong> å·²åŠ è½½${questions.length}é“é¢˜ç›®ï¼Œé¡µé¢å†…å®¹è¾ƒå¤šã€‚å»ºè®®ä½¿ç”¨æµè§ˆå™¨çš„æŸ¥æ‰¾åŠŸèƒ½ï¼ˆCtrl+F / Cmd+Fï¼‰æ¥å¿«é€Ÿå®šä½ç‰¹å®šé¢˜ç›®ã€‚
                </div>`;
            }
            
            questions.forEach(question => {
                const typeClass = getTypeClass(question.question_type);
                html += `
                    <div class="question-item">
                        <div class="question-header">
                            <span class="question-number">ç¬¬${question.question_number}é¢˜</span>
                            <span class="question-type ${typeClass}">${question.question_type}</span>
                            <button onclick="viewQuestionDetail('${question.id}')" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                        <div class="question-meta">
                            ğŸ“ å›¾ç‰‡æ•°é‡: ${question.total_images || 0}å¼  | 
                            ğŸ“„ æ®µè½èŒƒå›´: ${question.paragraph_range || 'æœªçŸ¥'} | 
                            ğŸ•’ åˆ›å»ºæ—¶é—´: ${question.created_at ? new Date(question.created_at).toLocaleString() : 'æœªçŸ¥'}
                        </div>
                        <div id="detail-${question.id}" class="question-detail" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #667eea;">
                            <div class="loading-detail">æ­£åœ¨åŠ è½½é¢˜ç›®è¯¦æƒ…...</div>
                        </div>
                    </div>
                `;
            });

            questionsList.innerHTML = html;
        }

        function updatePaginationBar() {
            const bar = document.getElementById('paginationBar');
            const info = document.getElementById('pageInfo');
            const prev = document.getElementById('prevPageBtn');
            const next = document.getElementById('nextPageBtn');
            if (!bar) return;
            const totalPages = Math.max(1, Math.ceil((state.total || 0) / state.pageSize));
            bar.style.display = totalPages > 1 ? 'block' : 'none';
            info.textContent = `ç¬¬ ${state.page} / ${totalPages} é¡µï¼ˆå…± ${state.total} é“ï¼‰`;
            prev.disabled = state.page <= 1;
            next.disabled = state.page >= totalPages;
        }

        function prevPage() {
            if (state.page > 1) {
                state.page -= 1;
                reloadList();
            }
        }

        function nextPage() {
            const totalPages = Math.max(1, Math.ceil((state.total || 0) / state.pageSize));
            if (state.page < totalPages) {
                state.page += 1;
                reloadList();
            }
        }

        function updateExpectedCard(currentCount, total) {
            const node = document.getElementById('statTotalExpected');
            if (node) {
                node.textContent = `${currentCount}/${total}`;
            }
        }

        async function refreshStatsAndFilters() {
            try {
                const res = await fetch('/api/v1/questions/stats');
                const s = await res.json();
                // ç»Ÿè®¡æ•°å­—
                const totalNode = document.querySelector('.stats .stat-card .stat-number');
                const allCards = document.querySelectorAll('.stats .stat-card .stat-number');
                if (allCards && allCards.length >= 2) {
                    allCards[0].textContent = s.total_questions;
                    allCards[1].textContent = s.total_extractions;
                }
                // é¢˜å‹åˆ†å¸ƒ
                const typeBlock = document.getElementById('typeDistributionBlock');
                const typeContainer = document.getElementById('typeDistribution');
                const typeCountNode = document.getElementById('statTypeCount');
                const typeFilter = document.getElementById('typeFilter');
                // å›ºå®šé¢˜å‹åç§°ä¸å±•ç¤ºé¡ºåºï¼ˆç¬¬ä¸€åˆ°ç¬¬å…­å¤§é¢˜ï¼‰
                // 1. æ”¿æ²»ç†è®º 2. å¸¸è¯†åˆ¤æ–­ 3. è¨€è¯­ç†è§£ä¸è¡¨è¾¾ 4. æ•°é‡å…³ç³» 5. åˆ¤æ–­æ¨ç† 6. èµ„æ–™åˆ†æ
                const NORMALIZED_ORDER = ['æ”¿æ²»ç†è®º','å¸¸è¯†åˆ¤æ–­','è¨€è¯­ç†è§£ä¸è¡¨è¾¾','æ•°é‡å…³ç³»','åˆ¤æ–­æ¨ç†','èµ„æ–™åˆ†æ'];
                const normalizeName = (raw) => {
                    const t = String(raw || '');
                    if (t.includes('è¨€è¯­')) return 'è¨€è¯­ç†è§£ä¸è¡¨è¾¾';
                    if (t.includes('èµ„æ–™')) return 'èµ„æ–™åˆ†æ';
                    if (t.includes('å¸¸è¯†')) return 'å¸¸è¯†åˆ¤æ–­';
                    if (t.includes('åˆ¤æ–­')) return 'åˆ¤æ–­æ¨ç†';
                    if (t.includes('æ•°é‡')) return 'æ•°é‡å…³ç³»';
                    if (t.includes('æ”¿æ²»')) return 'æ”¿æ²»ç†è®º';
                    return t || 'æœªçŸ¥';
                };
                const counts = {};
                (s.type_distribution || []).forEach((t) => {
                    const name = normalizeName(t.type);
                    counts[name] = (counts[name] || 0) + (t.count || 0);
                });
                if (Array.isArray(s.type_distribution) && s.type_distribution.length > 0) {
                    typeBlock.style.display = 'block';
                    // æ˜¾ç¤ºé¢˜å‹åç§°ä¸æ•°é‡
                    typeContainer.innerHTML = NORMALIZED_ORDER.map(n => {
                        const cnt = counts[n] || 0;
                        return `<div class="type-item"><strong>${n}</strong><div style="margin-top:6px;color:#666;">${cnt} é“</div></div>`;
                    }).join('');
                    if (typeCountNode) typeCountNode.textContent = NORMALIZED_ORDER.length;
                    // æ›´æ–°ç­›é€‰ä¸‹æ‹‰ä¸ºè§„èŒƒåŒ–åçš„é¢˜å‹å
                    const current = typeFilter.value;
                    typeFilter.innerHTML = '<option value="">ğŸ“š å…¨éƒ¨é¢˜å‹</option>' +
                        NORMALIZED_ORDER.filter(n => (counts[n] || 0) > 0)
                        .map(n => `<option value="${n}">${n}${counts[n] ? `ï¼ˆ${counts[n]}ï¼‰` : ''}</option>`)
                        .join('');
                    typeFilter.value = current && [...typeFilter.options].some(o => o.value === current) ? current : '';
                } else {
                    typeBlock.style.display = 'none';
                    typeContainer.innerHTML = '';
                    if (typeCountNode) typeCountNode.textContent = '0';
                    // æ¸…ç©ºç­›é€‰
                    typeFilter.innerHTML = '<option value="">ğŸ“š å…¨éƒ¨é¢˜å‹</option>';
                }
            } catch (e) {
                // å¿½ç•¥ç»Ÿè®¡å¤±è´¥
            }

            // é¢˜å‹æ´å¯Ÿï¼šå±•ç¤ºåŸå§‹å€¼ä¸è§„èŒƒæ˜ å°„
            try {
                const res2 = await fetch('/api/v1/questions/type-insights');
                if (res2.ok) {
                    const t = await res2.json();
                    const block = document.getElementById('typeInsightsBlock');
                    const container = document.getElementById('typeInsights');
                    const rows = t.mappings || [];
                    if (rows.length > 0) {
                        block.style.display = 'block';
                        container.innerHTML = rows.map(r => {
                            const same = (r.raw === r.normalized);
                            const color = same ? '#2f855a' : '#c05621';
                            const tip = same ? 'å·²è§„èŒƒ' : 'éœ€æ¸…æ´—';
                            return `<div style="background:#fff; padding:12px; border-radius:8px; border-left:4px solid ${color};">
                                <div style="font-weight:600;">${r.raw}</div>
                                <div style="color:#666; font-size:12px;">â†’ ${r.normalized} | <span style="color:${color}">${tip}</span></div>
                                <div style="margin-top:6px; color:#666;">${r.count} é“</div>
                            </div>`;
                        }).join('');
                    } else {
                        block.style.display = 'none';
                        container.innerHTML = '';
                    }
                }
            } catch {}
        }

        // è·å–é¢˜å‹å¯¹åº”çš„CSSç±»
        function getTypeClass(questionType) {
            if (!questionType) return '';
            if (questionType.includes('æ”¿æ²»')) return 'type-politics';
            if (questionType.includes('å¸¸è¯†')) return 'type-common';
            if (questionType.includes('è¨€è¯­')) return 'type-language';
            if (questionType.includes('æ•°é‡')) return 'type-math';
            if (questionType.includes('åˆ¤æ–­')) return 'type-logic';
            return '';
        }

        // æŸ¥çœ‹é¢˜ç›®è¯¦æƒ…
        async function viewQuestionDetail(questionId) {
            const detailElement = document.getElementById(`detail-${questionId}`);
            
            // åˆ‡æ¢æ˜¾ç¤º/éšè—
            if (detailElement.style.display === 'block') {
                detailElement.style.display = 'none';
                return;
            }
            
            detailElement.style.display = 'block';
            detailElement.innerHTML = '<div class="loading-detail">æ­£åœ¨åŠ è½½é¢˜ç›®è¯¦æƒ…...</div>';
            
            try {
                const response = await fetch(`/api/v1/questions/${questionId}`);
                if (response.ok) {
                    const questionData = response.json();
                    displayQuestionDetail(detailElement, await questionData);
                } else {
                    detailElement.innerHTML = '<div class="alert error">åŠ è½½é¢˜ç›®è¯¦æƒ…å¤±è´¥</div>';
                }
            } catch (error) {
                console.error('åŠ è½½é¢˜ç›®è¯¦æƒ…å¤±è´¥:', error);
                detailElement.innerHTML = '<div class="alert error">åŠ è½½è¯¦æƒ…å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        // æ˜¾ç¤ºé¢˜ç›®è¯¦æƒ…å†…å®¹
        async function displayQuestionDetail(container, questionData) {
            let content = questionData.content;
            
            // å¦‚æœcontentæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æJSON
            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    console.error('è§£æcontent JSONå¤±è´¥:', e);
                    container.innerHTML = '<div class="alert error">é¢˜ç›®å†…å®¹æ ¼å¼é”™è¯¯</div>';
                    return;
                }
            }
            
            let allImages = Array.isArray(questionData.images) ? questionData.images : [];
            const optionRe = /^[A-Dï¼¡-ï¼¤][\s\t]*[ã€\.ï¼\)]/;
            let materialImgs = allImages.filter(img => (img.image_type === 'material') || (!img.image_type && !optionRe.test((img.context_text||'').trim())));
            let optionImgs = allImages.filter(img => (img.image_type === 'option') || optionRe.test((img.context_text||'').trim()));
            // å°†é€‰é¡¹å›¾ç‰‡æŒ‰æ®µè½ç´¢å¼•åˆ†ç»„ï¼Œä¾¿äºå†…è”åˆ°å¯¹åº”é€‰é¡¹
            const imgsByParaIndex = {};
            (optionImgs || []).forEach(img => {
                const idx = Number(img.paragraph_index ?? -1);
                if (idx >= 0) {
                    if (!imgsByParaIndex[idx]) imgsByParaIndex[idx] = [];
                    imgsByParaIndex[idx].push(img);
                }
            });
            const embeddedOptionUrls = new Set();

            // èµ„æ–™åˆ†æï¼šä¸ºç»„å†…éé¦–é¢˜è‡ªåŠ¨è¡¥å……æœ¬ç»„é¢˜å¹²ææ–™ï¼ˆå–ç»„é¦–é¢˜çš„ææ–™å›¾ï¼‰
            try {
                if ((questionData.question_type || '').includes('èµ„æ–™åˆ†æ')) {
                    const qn = Number(questionData.question_number || 0);
                    if (qn && (qn - 1) % 5 !== 0) {
                        const groupStart = qn - ((qn - 1) % 5);
                        const listRes = await fetch(`/api/v1/questions?page=1&page_size=1&question_number=${groupStart}`);
                        if (listRes.ok) {
                            const listJson = await listRes.json();
                            const leader = (listJson.questions && listJson.questions[0]) ? listJson.questions[0] : null;
                            if (leader && leader.id) {
                                const leaderRes = await fetch(`/api/v1/questions/${leader.id}`);
                                if (leaderRes.ok) {
                                    const leaderDetail = await leaderRes.json();
                                    const leaderImgs = Array.isArray(leaderDetail.images) ? leaderDetail.images : [];
                                    const leaderMaterials = leaderImgs.filter(img => (img.image_type === 'material') || (!img.image_type && !optionRe.test((img.context_text || '').trim())));
                                    if (materialImgs.length === 0 && leaderMaterials.length > 0) {
                                        const existNames = new Set(materialImgs.map(i => i.url));
                                        leaderMaterials.forEach(i => { if (!existNames.has(i.url)) materialImgs.push(i); });
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (e) { /* å¿½ç•¥è¡¥å……ææ–™å¤±è´¥ */ }

            let html = `
                <div style="margin-bottom: 15px;">
                    <h4>ğŸ“‹ é¢˜ç›® ${questionData.question_number} è¯¦ç»†å†…å®¹</h4>
                    <p><strong>é¢˜å‹:</strong> ${questionData.question_type}</p>
                    <p><strong>æ®µè½èŒƒå›´:</strong> ${questionData.paragraph_range}</p>
                    <p><strong>å›¾ç‰‡ç»Ÿè®¡:</strong> ææ–™å›¾ ${questionData.total_images || 0} å¼  | é€‰é¡¹å›¾ ${optionImgs.length} å¼ </p>
                </div>
            `;
            
            // ææ–™å›¾ç‰‡ä¼˜å…ˆå±•ç¤º
            if (materialImgs.length > 0) {
                html += `
                    <div style="margin-bottom: 16px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2b6cb0;">
                        <h5 style="color: #2b6cb0; margin-bottom: 10px;">ğŸ“š é¢˜å¹²ææ–™å›¾ç‰‡ (${materialImgs.length}å¼ )</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                `;
                materialImgs.forEach((image, idx) => {
                    html += `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: white;">
                            <div style="text-align: center; margin-bottom: 6px;">
                                <img src="${image.url}" alt="ææ–™å›¾ ${idx + 1}" style="max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 4px; cursor: pointer;" onclick="window.open('${image.url}', '_blank')" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22100%22%20height%3D%22100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23f0f0f0%22/%3E%3Ctext%20x%3D%2250%22%20y%3D%2255%22%20text-anchor%3D%22middle%22%20fill%3D%22%23999%22%20font-size%3D%2212%22%3E%E5%8A%A0%E8%BD%BD%E5%A4%B1%E8%B4%A5%3C/text%3E%3C/svg%3E'; this.onclick=null;">
                            </div>
                            <div style="font-size: 11px; color: #666; text-align: center;">ææ–™å›¾ ${idx + 1} | æ®µè½ ${image.paragraph_index + 1}</div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // ä¿ç•™å…œåº•æç¤ºï¼šè‹¥ç»Ÿè®¡æœ‰å›¾ä½†æœªæå–åˆ°é€‰é¡¹å›¾
            if (optionImgs.length === 0 && (questionData.total_images || 0) > 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffecb3; border-radius: 5px; color: #856404;">
                        ğŸ“· <strong>æ³¨æ„:</strong> æ­¤é¢˜ç›®åŒ…å« ${questionData.total_images} å¼ å›¾ç‰‡ï¼Œä½†å›¾ç‰‡æ•°æ®æœªèƒ½æå–ã€‚å¯èƒ½éœ€è¦é‡æ–°ä¸Šä¼ æ–‡æ¡£æ¥è·å–å›¾ç‰‡ã€‚
                    </div>
                `;
            }
            
            html += '<div class="question-content">';
            
            if (content && content.paragraphs && Array.isArray(content.paragraphs)) {
                html += '<div style="margin-bottom:10px;">'
                    + '<button onclick="toggleAllParagraphs(this)" style="background:#667eea;color:#fff;border:none;padding:6px 10px;border-radius:4px;margin-right:8px;">å…¨éƒ¨å±•å¼€</button>'
                    + '<button onclick="copyQuestionText(this)" style="background:#6c757d;color:#fff;border:none;padding:6px 10px;border-radius:4px;">å¤åˆ¶å…¨æ–‡</button>'
                    + '</div>';

                content.paragraphs.forEach((para, index) => {
                    if (para.text && para.text.trim()) {
                        const preview = (para.text.length > 120) ? (para.text.slice(0, 120) + '...') : para.text;
                        const collapsed = para.text.length > 120;
                        const isOptionPara = optionRe.test((para.text || '').trim());
                        let optionInlineHtml = '';
                        if (isOptionPara) {
                            const imgs = imgsByParaIndex[para.paragraph_index] || [];
                            if (imgs.length > 0) {
                                optionInlineHtml += '<div class="option-inline-images" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">';
                                imgs.forEach(img => {
                                    embeddedOptionUrls.add(img.url);
                                    optionInlineHtml += `<img src="${img.url}" alt="é€‰é¡¹å›¾" style="max-width:140px; max-height:140px; object-fit:contain; border:1px solid #e5e7eb; border-radius:6px; padding:4px; background:#fff; cursor:pointer;" onclick="window.open('${img.url}','_blank')" onerror="this.style.display='none'">`;
                                });
                                optionInlineHtml += '</div>';
                            }
                        }
                        html += `
                            <div class="para-item" data-full="${encodeURIComponent(para.text)}" style="margin: 10px 0; padding: 8px; background: white; border-radius: 3px; border: 1px solid #eee;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                  <div style="font-size: 12px; color: #666;">
                                      æ®µè½${index + 1} | ${para.images_count || 0}å¼ å›¾ç‰‡ | ${para.text_length || para.text.length}å­—ç¬¦
                                  </div>
                                  <button class="toggle-btn" onclick="toggleParagraph(this)" style="background:#e2e8f0;color:#333;border:none;padding:4px 8px;border-radius:4px;font-size:12px;">${collapsed ? 'å±•å¼€' : 'æ”¶èµ·'}</button>
                                </div>
                                <div class="para-text" data-collapsed="${collapsed}" style="line-height: 1.5; word-wrap: break-word; margin-top:6px;">${collapsed ? preview : para.text}</div>
                                ${optionInlineHtml}
                            </div>
                        `;
                    }
                });
                
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
                        <strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:</strong><br>
                        æ€»æ®µè½æ•°: ${content.paragraph_count || content.paragraphs.length}<br>
                        æ€»å›¾ç‰‡æ•°: ${content.total_images || 0}å¼ <br>
                        æ€»æ–‡å­—é•¿åº¦: ${content.total_text_length || 0}å­—ç¬¦
                    </div>
                `;

                // è‹¥è¿˜æœ‰æœªèƒ½å†…è”åˆ°é€‰é¡¹æ®µè½çš„å›¾ç‰‡ï¼Œä½œä¸ºå…œåº•å±•ç¤ºåœ¨è¿™é‡Œ
                const leftover = (optionImgs || []).filter(img => !embeddedOptionUrls.has(img.url));
                if (leftover.length > 0) {
                    html += `
                        <div style="margin-top: 16px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #38a169;">
                            <h5 style="color: #38a169; margin-bottom: 10px;">ğŸ”  é€‰é¡¹å›¾ç‰‡ï¼ˆå‰©ä½™${leftover.length}å¼ ï¼Œæœªèƒ½å®šä½åˆ°å…·ä½“é€‰é¡¹å¤„ï¼‰</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
                    `;
                    leftover.forEach(image => {
                        const ctx = (image.context_text || '').trim();
                        const label = ctx ? ctx.replace(/\s+/g,'').slice(0,1).replace('ï¼¡','A').replace('ï¼¢','B').replace('ï¼£','C').replace('ï¼¤','D') : '';
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: white;">
                                <div style="text-align: center; margin-bottom: 6px;">
                                    <img src="${image.url}" alt="é€‰é¡¹${label}" style="max-width: 100%; max-height: 160px; object-fit: contain; border-radius: 4px; cursor: pointer;" onclick="window.open('${image.url}', '_blank')" onerror="this.style.display='none'">
                                </div>
                                <div style="font-size: 11px; color: #666; text-align: center;">é€‰é¡¹ ${label || '?'} ${ctx ? '<br>ä¸Šä¸‹æ–‡: ' + ctx.substring(0, 30) + (ctx.length > 30 ? '...' : '') : ''}</div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }
            } else {
                html += '<div style="color: #666; text-align: center; padding: 20px;">æš‚æ— è¯¦ç»†å†…å®¹æˆ–å†…å®¹æ ¼å¼å¼‚å¸¸</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleParagraph(button) {
            const item = button.closest('.para-item');
            const textNode = item.querySelector('.para-text');
            const collapsed = textNode.getAttribute('data-collapsed') === 'true';
            if (collapsed) {
                textNode.textContent = decodeURIComponent(item.getAttribute('data-full'));
                textNode.setAttribute('data-collapsed', 'false');
                button.textContent = 'æ”¶èµ·';
            } else {
                const full = decodeURIComponent(item.getAttribute('data-full'));
                const preview = full.length > 120 ? (full.slice(0,120)+'...') : full;
                textNode.textContent = preview;
                textNode.setAttribute('data-collapsed', 'true');
                button.textContent = 'å±•å¼€';
            }
        }

        function toggleAllParagraphs(btn) {
            const container = btn.closest('.question-detail');
            const items = container.querySelectorAll('.para-item');
            const expand = btn.textContent.includes('å±•å¼€');
            items.forEach(item => {
                const textNode = item.querySelector('.para-text');
                const toggleBtn = item.querySelector('.toggle-btn');
                const full = decodeURIComponent(item.getAttribute('data-full'));
                if (expand) {
                    textNode.textContent = full;
                    textNode.setAttribute('data-collapsed', 'false');
                    toggleBtn.textContent = 'æ”¶èµ·';
                } else {
                    const preview = full.length > 120 ? (full.slice(0,120)+'...') : full;
                    textNode.textContent = preview;
                    textNode.setAttribute('data-collapsed', 'true');
                    toggleBtn.textContent = 'å±•å¼€';
                }
            });
            btn.textContent = expand ? 'å…¨éƒ¨æ”¶èµ·' : 'å…¨éƒ¨å±•å¼€';
        }

        function copyQuestionText(btn) {
            const container = btn.closest('.question-detail');
            const texts = [...container.querySelectorAll('.para-item')].map(it => decodeURIComponent(it.getAttribute('data-full')));
            const all = texts.join('\n\n');
            navigator.clipboard.writeText(all).then(() => {
                showAlert('å·²å¤åˆ¶é¢˜ç›®å…¨æ–‡', 'success');
            }).catch(() => {
                showAlert('å¤åˆ¶å¤±è´¥', 'error');
            });
        }

        // æ˜¾ç¤ºæ¸…ç©ºé¢˜åº“å¯¹è¯æ¡†
        function showClearDialog() {
            const message = `âš ï¸  å±é™©æ“ä½œç¡®è®¤\n\n` +
                          `å³å°†æ¸…ç©ºæ‰€æœ‰é¢˜åº“æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\n` +
                          `â€¢ æ‰€æœ‰é¢˜ç›®æ–‡æœ¬å†…å®¹\n` +
                          `â€¢ æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶\n` +
                          `â€¢ é¢˜ç›®åˆ†ç±»å’Œå…ƒä¿¡æ¯\n\n` +
                          `æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`;
                          
            if (confirm(message)) {
                // è¯¢é—®æ˜¯å¦åŒæ—¶æ¸…ç©ºå†å²è®°å½•
                const clearHistory = confirm(
                    `æ˜¯å¦åŒæ—¶æ¸…ç©ºæå–å†å²è®°å½•ï¼Ÿ\n\n` +
                    `â€¢ é€‰æ‹©"ç¡®å®š"ï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å†å²è®°å½•ï¼‰\n` +
                    `â€¢ é€‰æ‹©"å–æ¶ˆ"ï¼šä¿ç•™å†å²è®°å½•ï¼Œä»…æ¸…ç©ºé¢˜ç›®æ•°æ®`
                );
                
                clearAllQuestions(clearHistory);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é¢˜ç›®
        async function clearAllQuestions(clearHistory = false) {
            const clearButton = document.getElementById('clearAllButton');
            
            // ç¦ç”¨æŒ‰é’®
            clearButton.disabled = true;
            clearButton.innerHTML = 'ğŸ”„ æ¸…ç©ºä¸­...';
            
            try {
                const response = await fetch(`/api/v1/questions/clear-all?clear_history=${clearHistory}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const stats = result.statistics;
                    showAlert(
                        `ğŸ‰ é¢˜åº“æ¸…ç©ºæˆåŠŸï¼\\n\\n` +
                        `ğŸ“Š æ¸…ç†ç»Ÿè®¡:\\n` +
                        `â€¢ åˆ é™¤é¢˜ç›®ï¼š${stats.deleted_questions}é“\\n` +
                        `â€¢ åˆ é™¤å›¾ç‰‡è®°å½•ï¼š${stats.deleted_images_records}æ¡\\n` +
                        `â€¢ åˆ é™¤å›¾ç‰‡æ–‡ä»¶ï¼š${stats.deleted_image_files}ä¸ª\\n` +
                        `${stats.history_cleared ? 'â€¢ åˆ é™¤å†å²è®°å½•ï¼š' + stats.deleted_history + 'æ¡\\n' : ''}\\n` +
                        `âœ… é¢˜åº“å·²å®Œå…¨æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¯¼å…¥æ•°æ®äº†ï¼`,
                        'success'
                    );
                    
                    // 2ç§’ååˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                    
                } else {
                    throw new Error(result.detail || result.message || 'æ¸…ç©ºå¤±è´¥');
                }
                
            } catch (error) {
                console.error('æ¸…ç©ºé¢˜åº“å¤±è´¥:', error);
                showAlert('æ¸…ç©ºé¢˜åº“å¤±è´¥: ' + error.message, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                clearButton.disabled = false;
                clearButton.innerHTML = 'ğŸ—‘ï¸ æ¸…ç©ºé¢˜åº“';
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const uploadResult = document.getElementById('uploadResult');
            const alertClass = type === 'success' ? 'success' : 'error';
            
            uploadResult.innerHTML = `<div class="alert ${alertClass}">${message.replace(/\\n/g, '<br>')}</div>`;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ—¶é—´
            const displayTime = type === 'success' ? 8000 : 5000;
            setTimeout(() => {
                uploadResult.innerHTML = '';
            }, displayTime);
        }
    </script>
</body>
</html>



