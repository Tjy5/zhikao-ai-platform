系统设计文档 (SDD): 智考公考伴侣
版本: V1.1 (MVP 阶段)
日期: 2025年9月5日 (更新于 2025年9月12日)
关联文档: 《智考公考伴侣 - 产品需求文档 V1.1》

1. 引言
本文档旨在为“智考公考伴侣” MVP 版本的开发提供全面的技术设计方案。它将基于 PRD V1.1 中定义的功能需求，详细阐述系统架构、技术选型、模块设计、API 接口、数据库结构以及核心 AI 服务的实现思路。

2. 系统架构
为确保系统的可扩展性、可维护性和开发效率，我们将采用前后端分离的架构。

**当前状态**: 已实现一个单体 FastAPI 后端和一个 Next.js 前端，并已成功集成 OpenAI AI 服务，形成申论批改的核心功能闭环。

2.1 架构图 (MVP)
(架构图暂未更新)

2.2 架构说明
用户端 (Client): 负责用户交互和界面展示，通过 API 与后端通信。 **(✅ 已实现)**
后端 (Backend):
- **申论服务**: 负责处理申论文章的提交、存储，并与 AI 服务交互获取批改结果。 **(✅ 已实现)**
- 学习与题库服务: 负责 MVP 的核心业务逻辑。 **(⚪️ 待开发)**
AI 服务 (AI Services):
- **申论批改服务**: 通过直接调用 OpenAI API 实现。 **(✅ 已实现)**
- 智能诊断与推荐服务: 执行能力评估算法。 **(⚪️ 待开发)**
数据存储 (Data Storage):
- **PostgreSQL**: 主数据库，存储所有核心业务数据。 **(✅ 已实现)**

3. 技术栈选型
**当前状态**: 技术选型基本与计划一致。
前端: React.js + Next.js (TypeScript) **(✅ 已采用)**
后端: Python 3.10+ & FastAPI **(✅ 已采用)**
数据库: PostgreSQL **(✅ 已采用)**
AI/ML: **OpenAI API** (替代了原计划的本地模型) **(✅ 已采用)**
容器化: Docker **(✅ 已采用)**
部署: **(⚪️ 待规划)**

4. 模块设计与 API 接口
所有 API 接口都将遵循 RESTful 风格。

4.1 学习与题库服务 (Learning & QuestionBank Service)
**状态: ⚪️ 待开发**
职责: 智能诊断、学习计划、题库练习、错题本、学习报告。
核心 API Endpoints:
- `GET /api/v1/diagnosis/start`
- `POST /api/v1/diagnosis/submit`
- ... (其他接口)

4.2 申论服务 (Shenlun Service)
**状态: ✅ 已完成**
职责: 申论文章提交、批改结果查询、历史记录管理。
**已实现 API Endpoints**: (所有接口均已实现并投入使用)
- `POST /api/v1/essays/grade-progressive` (提交申论文章，获取流式批改结果)
- `POST /api/v1/essays/grade` (标准批改接口，作为流式接口的降级备用)
- `GET /api/v1/essays/history` (获取历史记录列表)
- `GET /api/v1/essays/history/{item_id}` (获取单条历史记录)
- `DELETE /api/v1/essays/history` (清空历史记录)
- `GET /api/v1/essays/ai-status` (检查AI服务状态)

5. 数据库设计 (PostgreSQL)
以下是 MVP 阶段的核心数据表结构设计。

**history (历史记录表)**
**状态: ✅ 已创建并使用**
- `id` (String, PK)
- `created_at` (TIMESTAMP)
- `kind` (VARCHAR) - 'progressive' 或 'grade'
- `question_type` (VARCHAR)
- `score` (FLOAT)
- `request_json` (JSONB) - 存储用户提交的内容
- `response_json` (JSONB) - 存储完整的AI批改结果
- `extra_json` (JSONB) - 存储额外信息 (如第一阶段诊断结果)

**questions (题目表)**
**状态: ⚪️ 待开发**

**practice_records (练习记录表)**
**状态: ⚪️ 待开发**

**wrong_questions (错题本表)**
**状态: ⚪️ 待开发**

**learning_plans (学习计划表)**
**状态: ⚪️ 待开发**

**learning_tasks (学习任务表)**
**状态: ⚪️ 待开发**

6. 核心 AI 模块设计 (MVP)
6.1 智能诊断与推荐服务
**状态: ⚪️ 待开发**
输入: 用户诊断测试的答题记录（题目ID、答案、耗时）。
核心算法:
- 能力评估: 基于知识点图谱和答题正确率，计算用户在各个模块和知识点上的初步掌握度分数。
- 弱点识别: 找出掌握度分数最低的 3-5 个知识点作为核心弱点。
- 学习计划生成: 采用基于规则的策略，为用户生成一个为期 N 周的学习计划。
输出:
- 一份包含各模块能力分数的诊断报告 (JSON)。
- 一个结构化的学习任务列表 (JSON)。

6.2 申论批改服务 (MVP)
**状态: ✅ 已完成 (已投入生产)**
输入: 申论材料文本、用户提交的文章文本。
**已实现核心算法**:
- **AI 模型**: 直接调用 **OpenAI GPT-4o-mini** 等大语言模型，能力远超原计划的本地模型。
- **双阶段评分**: (已实现并优化)
  1.  **专家诊断**: AI 首先对文章进行细致的逐句分析和诊断。
  2.  **整体评估**: AI 随后生成总分、综合评语和改进建议。
- **流式响应 (Streaming Response)**: 后端通过 SSE (Server-Sent Events) 将两阶段的结果实时推送给前端，极大提升了用户体验。
输出:
- 结构化的流式 JSON 数据，包含进度、状态、评分细则、总分、反馈和建议。